<div class="affected-state-viewer">
  @if (states.length > 0) {
    <table class="state-table">
      <thead>
        <tr>
          <th class="col-resource">Resource</th>
          <th class="col-property">Property</th>
          <th class="col-before">Before</th>
          <th class="col-expected">Expected</th>
          <th class="col-change">Change</th>
          @if (editable) {
            <th class="col-resolved">Actual Value</th>
          }
        </tr>
      </thead>
      <tbody>
        @for (state of states; track state) {
          <tr class="state-row">
            <td class="col-resource">
              <div class="resource-cell">
                <mat-icon class="resource-icon">science</mat-icon>
                <span class="resource-name">{{ state.resource_name || 'Unknown' }}</span>
              </div>
            </td>
            <td class="col-property">
              <div class="property-cell">
                <mat-icon class="property-icon">{{ getPropertyIcon(state.property_type) }}</mat-icon>
                <span class="property-name">{{ getPropertyTypeLabel(state.property_type) }}</span>
              </div>
            </td>
            <td class="col-before">
              <span class="value-cell value-before">{{ formatValue(state.current_value) }}</span>
            </td>
            <td class="col-expected">
              <span class="value-cell value-expected">
                {{ state.expected_value !== undefined ? formatValue(state.expected_value) : 'â€”' }}
              </span>
            </td>
            <td class="col-change">
              <div class="change-indicator" [class]="getChangeClass(state)"
                [matTooltip]="getChangeTooltip(state)">
                @if (getChangeClass(state) === 'change-increase') {
                  <mat-icon>arrow_upward</mat-icon>
                }
                @if (getChangeClass(state) === 'change-decrease') {
                  <mat-icon>arrow_downward</mat-icon>
                }
                @if (getChangeClass(state) === 'change-modified') {
                  <mat-icon>swap_horiz</mat-icon>
                }
                @if (getChangeClass(state) === 'change-none') {
                  <mat-icon>remove</mat-icon>
                }
                @if (getChangeClass(state) === 'change-unknown') {
                  <mat-icon>help</mat-icon>
                }
              </div>
            </td>
            @if (editable) {
              <td class="col-resolved">
                <input type="text" class="value-input" [value]="formatValue(getResolvedValue(state.state_key))"
                  (input)="onValueChange(state.state_key, $event)" placeholder="Enter value" />
              </td>
            }
          </tr>
        }
      </tbody>
    </table>
  }

  @if (states.length === 0) {
    <div class="empty-state">
      <mat-icon>check_circle</mat-icon>
      <p>No uncertain state changes detected.</p>
    </div>
  }
</div>