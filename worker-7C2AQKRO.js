var w=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,r)=>(typeof require<"u"?require:t)[r]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var Ne=Object.defineProperty,s=(e,t)=>Ne(e,"name",{value:t,configurable:!0}),j=(e=>typeof w<"u"?w:typeof Proxy<"u"?new Proxy(e,{get:(t,r)=>(typeof w<"u"?w:t)[r]}):e)(function(e){if(typeof w<"u")return w.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')}),Oe=(()=>{for(var e=new Uint8Array(128),t=0;t<64;t++)e[t<26?t+65:t<52?t+71:t<62?t-4:t*4-205]=t;return r=>{for(var o=r.length,a=new Uint8Array((o-(r[o-1]=="=")-(r[o-2]=="="))*3/4|0),n=0,i=0;n<o;){var c=e[r.charCodeAt(n++)],l=e[r.charCodeAt(n++)],d=e[r.charCodeAt(n++)],u=e[r.charCodeAt(n++)];a[i++]=c<<2|l>>4,a[i++]=l<<4|d>>2,a[i++]=d<<6|u}return a}})();function z(e){return!isNaN(parseFloat(e))&&isFinite(e)}s(z,"_isNumber");function E(e){return e.charAt(0).toUpperCase()+e.substring(1)}s(E,"_capitalize");function F(e){return function(){return this[e]}}s(F,"_getter");var v=["isConstructor","isEval","isNative","isToplevel"],N=["columnNumber","lineNumber"],O=["fileName","functionName","source"],Pe=["args"],Ae=["evalOrigin"],L=v.concat(N,O,Pe,Ae);function m(e){if(e)for(var t=0;t<L.length;t++)e[L[t]]!==void 0&&this["set"+E(L[t])](e[L[t]])}s(m,"StackFrame");m.prototype={getArgs:s(function(){return this.args},"getArgs"),setArgs:s(function(e){if(Object.prototype.toString.call(e)!=="[object Array]")throw new TypeError("Args must be an Array");this.args=e},"setArgs"),getEvalOrigin:s(function(){return this.evalOrigin},"getEvalOrigin"),setEvalOrigin:s(function(e){if(e instanceof m)this.evalOrigin=e;else if(e instanceof Object)this.evalOrigin=new m(e);else throw new TypeError("Eval Origin must be an Object or StackFrame")},"setEvalOrigin"),toString:s(function(){var e=this.getFileName()||"",t=this.getLineNumber()||"",r=this.getColumnNumber()||"",o=this.getFunctionName()||"";return this.getIsEval()?e?"[eval] ("+e+":"+t+":"+r+")":"[eval]:"+t+":"+r:o?o+" ("+e+":"+t+":"+r+")":e+":"+t+":"+r},"toString")};m.fromString=s(function(e){var t=e.indexOf("("),r=e.lastIndexOf(")"),o=e.substring(0,t),a=e.substring(t+1,r).split(","),n=e.substring(r+1);if(n.indexOf("@")===0)var i=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(n,""),c=i[1],l=i[2],d=i[3];return new m({functionName:o,args:a||void 0,fileName:c,lineNumber:l||void 0,columnNumber:d||void 0})},"StackFrame$$fromString");for(_=0;_<v.length;_++)m.prototype["get"+E(v[_])]=F(v[_]),m.prototype["set"+E(v[_])]=(function(e){return function(t){this[e]=!!t}})(v[_]);var _;for(S=0;S<N.length;S++)m.prototype["get"+E(N[S])]=F(N[S]),m.prototype["set"+E(N[S])]=(function(e){return function(t){if(!z(t))throw new TypeError(e+" must be a Number");this[e]=Number(t)}})(N[S]);var S;for(k=0;k<O.length;k++)m.prototype["get"+E(O[k])]=F(O[k]),m.prototype["set"+E(O[k])]=(function(e){return function(t){this[e]=String(t)}})(O[k]);var k,D=m;function V(){var e=/^\s*at .*(\S+:\d+|\(native\))/m,t=/^(eval@)?(\[native code])?$/;return{parse:s(function(r){if(r.stack&&r.stack.match(e))return this.parseV8OrIE(r);if(r.stack)return this.parseFFOrSafari(r);throw new Error("Cannot parse given Error object")},"ErrorStackParser$$parse"),extractLocation:s(function(r){if(r.indexOf(":")===-1)return[r];var o=/(.+?)(?::(\d+))?(?::(\d+))?$/,a=o.exec(r.replace(/[()]/g,""));return[a[1],a[2]||void 0,a[3]||void 0]},"ErrorStackParser$$extractLocation"),parseV8OrIE:s(function(r){var o=r.stack.split(`
`).filter(function(a){return!!a.match(e)},this);return o.map(function(a){a.indexOf("(eval ")>-1&&(a=a.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));var n=a.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),i=n.match(/ (\(.+\)$)/);n=i?n.replace(i[0],""):n;var c=this.extractLocation(i?i[1]:n),l=i&&n||void 0,d=["eval","<anonymous>"].indexOf(c[0])>-1?void 0:c[0];return new D({functionName:l,fileName:d,lineNumber:c[1],columnNumber:c[2],source:a})},this)},"ErrorStackParser$$parseV8OrIE"),parseFFOrSafari:s(function(r){var o=r.stack.split(`
`).filter(function(a){return!a.match(t)},this);return o.map(function(a){if(a.indexOf(" > eval")>-1&&(a=a.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),a.indexOf("@")===-1&&a.indexOf(":")===-1)return new D({functionName:a});var n=/((.*".+"[^@]*)?[^@]*)(?:@)/,i=a.match(n),c=i&&i[1]?i[1]:void 0,l=this.extractLocation(a.replace(n,""));return new D({functionName:c,fileName:l[0],lineNumber:l[1],columnNumber:l[2],source:a})},this)},"ErrorStackParser$$parseFFOrSafari")}}s(V,"ErrorStackParser");var Re=new V,Ce=Re;function q(){if(typeof API<"u"&&API!==globalThis.API)return API.runtimeEnv;let e=typeof Bun<"u",t=typeof Deno<"u",r=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"&&!process.browser,o=typeof navigator=="object"&&typeof navigator.userAgent=="string"&&navigator.userAgent.indexOf("Chrome")===-1&&navigator.userAgent.indexOf("Safari")>-1;return G({IN_BUN:e,IN_DENO:t,IN_NODE:r,IN_SAFARI:o,IN_SHELL:typeof read=="function"&&typeof load=="function"})}s(q,"getGlobalRuntimeEnv");var f=q();function G(e){let t=e.IN_NODE&&typeof module<"u"&&module.exports&&typeof j=="function"&&typeof __dirname=="string",r=e.IN_NODE&&!t,o=!e.IN_NODE&&!e.IN_DENO&&!e.IN_BUN,a=o&&typeof window<"u"&&typeof window.document<"u"&&typeof document.createElement=="function"&&"sessionStorage"in window&&typeof globalThis.importScripts!="function",n=o&&typeof globalThis.WorkerGlobalScope<"u"&&typeof globalThis.self<"u"&&globalThis.self instanceof globalThis.WorkerGlobalScope;return{...e,IN_BROWSER:o,IN_BROWSER_MAIN_THREAD:a,IN_BROWSER_WEB_WORKER:n,IN_NODE_COMMONJS:t,IN_NODE_ESM:r}}s(G,"calculateDerivedFlags");var J,x,K,$,M;async function W(){if(!f.IN_NODE||(J=(await import("node:url")).default,$=await import("node:fs"),M=await import("node:fs/promises"),K=(await import("node:vm")).default,x=await import("node:path"),H=x.sep,typeof j<"u"))return;let e=$,t=await import("node:crypto"),r=await import("ws"),o=await import("node:child_process"),a={fs:e,crypto:t,ws:r,child_process:o};globalThis.require=function(n){return a[n]}}s(W,"initNodeModules");function X(e,t){return x.resolve(t||".",e)}s(X,"node_resolvePath");function Y(e,t){return t===void 0&&(t=location),new URL(e,t).toString()}s(Y,"browser_resolvePath");var C;f.IN_NODE?C=X:f.IN_SHELL?C=s(e=>e,"resolvePath"):C=Y;var H;f.IN_NODE||(H="/");function Z(e,t){return e.startsWith("file://")&&(e=e.slice(7)),e.includes("://")?{response:fetch(e)}:{binary:M.readFile(e).then(r=>new Uint8Array(r.buffer,r.byteOffset,r.byteLength))}}s(Z,"node_getBinaryResponse");function Q(e,t){if(e.startsWith("file://")&&(e=e.slice(7)),e.includes("://"))throw new Error("Shell cannot fetch urls");return{binary:Promise.resolve(new Uint8Array(readbuffer(e)))}}s(Q,"shell_getBinaryResponse");function ee(e,t){let r=new URL(e,location);return{response:fetch(r,t?{integrity:t}:{})}}s(ee,"browser_getBinaryResponse");var T;f.IN_NODE?T=Z:f.IN_SHELL?T=Q:T=ee;async function te(e,t){let{response:r,binary:o}=T(e,t);if(o)return o;let a=await r;if(!a.ok)throw new Error(`Failed to load '${e}': request failed.`);return new Uint8Array(await a.arrayBuffer())}s(te,"loadBinaryFile");var A;if(f.IN_BROWSER_MAIN_THREAD)A=s(async e=>await import(e),"loadScript");else if(f.IN_BROWSER_WEB_WORKER)A=s(async e=>{try{globalThis.importScripts(e)}catch(t){if(t instanceof TypeError)await import(e);else throw t}},"loadScript");else if(f.IN_NODE)A=re;else if(f.IN_SHELL)A=load;else throw new Error("Cannot determine runtime environment");async function re(e){e.startsWith("file://")&&(e=e.slice(7)),e.includes("://")?K.runInThisContext(await(await fetch(e)).text()):await import(J.pathToFileURL(e).href)}s(re,"nodeLoadScript");async function ie(e){if(f.IN_NODE){await W();let t=await M.readFile(e,{encoding:"utf8"});return JSON.parse(t)}else if(f.IN_SHELL){let t=read(e);return JSON.parse(t)}else return await(await fetch(e)).json()}s(ie,"loadLockFile");async function ne(){if(f.IN_NODE_COMMONJS)return __dirname;let e;try{throw new Error}catch(o){e=o}let t=Ce.parse(e)[0].fileName;if(f.IN_NODE&&!t.startsWith("file://")&&(t=`file://${t}`),f.IN_NODE_ESM){let o=await import("node:path");return(await import("node:url")).fileURLToPath(o.dirname(t))}let r=t.lastIndexOf(H);if(r===-1)throw new Error("Could not extract indexURL path from pyodide module location. Please pass the indexURL explicitly to loadPyodide.");return t.slice(0,r)}s(ne,"calculateDirname");function oe(e){return e.substring(0,e.lastIndexOf("/")+1)||globalThis.location?.toString()||"."}s(oe,"calculateInstallBaseUrl");function ae(e){let t=e.FS,r=e.FS.filesystems.MEMFS,o=e.PATH,a={DIR_MODE:16895,FILE_MODE:33279,mount:s(function(n){if(!n.opts.fileSystemHandle)throw new Error("opts.fileSystemHandle is required");return r.mount.apply(null,arguments)},"mount"),syncfs:s(async(n,i,c)=>{try{let l=a.getLocalSet(n),d=await a.getRemoteSet(n),u=i?d:l,h=i?l:d;await a.reconcile(n,u,h),c(null)}catch(l){c(l)}},"syncfs"),getLocalSet:s(n=>{let i=Object.create(null);function c(u){return u!=="."&&u!==".."}s(c,"isRealDir");function l(u){return h=>o.join2(u,h)}s(l,"toAbsolute");let d=t.readdir(n.mountpoint).filter(c).map(l(n.mountpoint));for(;d.length;){let u=d.pop(),h=t.stat(u);t.isDir(h.mode)&&d.push.apply(d,t.readdir(u).filter(c).map(l(u))),i[u]={timestamp:h.mtime,mode:h.mode}}return{type:"local",entries:i}},"getLocalSet"),getRemoteSet:s(async n=>{let i=Object.create(null),c=await Te(n.opts.fileSystemHandle);for(let[l,d]of c)l!=="."&&(i[o.join2(n.mountpoint,l)]={timestamp:d.kind==="file"?new Date((await d.getFile()).lastModified):new Date,mode:d.kind==="file"?a.FILE_MODE:a.DIR_MODE});return{type:"remote",entries:i,handles:c}},"getRemoteSet"),loadLocalEntry:s(n=>{let i=t.lookupPath(n,{}).node,c=t.stat(n);if(t.isDir(c.mode))return{timestamp:c.mtime,mode:c.mode};if(t.isFile(c.mode))return i.contents=r.getFileDataAsTypedArray(i),{timestamp:c.mtime,mode:c.mode,contents:i.contents};throw new Error("node type not supported")},"loadLocalEntry"),storeLocalEntry:s((n,i)=>{if(t.isDir(i.mode))t.mkdirTree(n,i.mode);else if(t.isFile(i.mode))t.writeFile(n,i.contents,{canOwn:!0});else throw new Error("node type not supported");t.chmod(n,i.mode),t.utime(n,i.timestamp,i.timestamp)},"storeLocalEntry"),removeLocalEntry:s(n=>{var i=t.stat(n);t.isDir(i.mode)?t.rmdir(n):t.isFile(i.mode)&&t.unlink(n)},"removeLocalEntry"),loadRemoteEntry:s(async n=>{if(n.kind==="file"){let i=await n.getFile();return{contents:new Uint8Array(await i.arrayBuffer()),mode:a.FILE_MODE,timestamp:new Date(i.lastModified)}}else{if(n.kind==="directory")return{mode:a.DIR_MODE,timestamp:new Date};throw new Error("unknown kind: "+n.kind)}},"loadRemoteEntry"),storeRemoteEntry:s(async(n,i,c)=>{let l=n.get(o.dirname(i)),d=t.isFile(c.mode)?await l.getFileHandle(o.basename(i),{create:!0}):await l.getDirectoryHandle(o.basename(i),{create:!0});if(d.kind==="file"){let u=await d.createWritable();await u.write(c.contents),await u.close()}n.set(i,d)},"storeRemoteEntry"),removeRemoteEntry:s(async(n,i)=>{await n.get(o.dirname(i)).removeEntry(o.basename(i)),n.delete(i)},"removeRemoteEntry"),reconcile:s(async(n,i,c)=>{let l=0,d=[];Object.keys(i.entries).forEach(function(y){let b=i.entries[y],I=c.entries[y];(!I||t.isFile(b.mode)&&b.timestamp.getTime()>I.timestamp.getTime())&&(d.push(y),l++)}),d.sort();let u=[];if(Object.keys(c.entries).forEach(function(y){i.entries[y]||(u.push(y),l++)}),u.sort().reverse(),!l)return;let h=i.type==="remote"?i.handles:c.handles;for(let y of d){let b=o.normalize(y.replace(n.mountpoint,"/")).substring(1);if(c.type==="local"){let I=h.get(b),ve=await a.loadRemoteEntry(I);a.storeLocalEntry(y,ve)}else{let I=a.loadLocalEntry(y);await a.storeRemoteEntry(h,b,I)}}for(let y of u)if(c.type==="local")a.removeLocalEntry(y);else{let b=o.normalize(y.replace(n.mountpoint,"/")).substring(1);await a.removeRemoteEntry(h,b)}},"reconcile")};e.FS.filesystems.NATIVEFS_ASYNC=a}s(ae,"initializeNativeFS");var Te=s(async e=>{let t=[];async function r(a){for await(let n of a.values())t.push(n),n.kind==="directory"&&await r(n)}s(r,"collect"),await r(e);let o=new Map;o.set(".",e);for(let a of t){let n=(await e.resolve(a)).join("/");o.set(n,a)}return o},"getFsHandles"),Le=Oe("AGFzbQEAAAABDANfAGAAAW9gAW8BfwMDAgECByECD2NyZWF0ZV9zZW50aW5lbAAAC2lzX3NlbnRpbmVsAAEKEwIHAPsBAPsbCwkAIAD7GvsUAAs="),Fe=(async function(){if(!(globalThis.navigator&&(/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&typeof navigator.maxTouchPoints<"u"&&navigator.maxTouchPoints>1)))try{let e=await WebAssembly.compile(Le);return await WebAssembly.instantiate(e)}catch(e){if(e instanceof WebAssembly.CompileError)return;throw e}})();async function se(){let e=await Fe;if(e)return e.exports;let t=Symbol("error marker");return{create_sentinel:s(()=>t,"create_sentinel"),is_sentinel:s(r=>r===t,"is_sentinel")}}s(se,"getSentinelImport");function ce(e){let t={config:e,runtimeEnv:f},r={noImageDecoding:!0,noAudioDecoding:!0,noWasmDecoding:!1,preRun:ye(e),print:e.stdout,printErr:e.stderr,onExit(o){r.exitCode=o},thisProgram:e._sysExecutable,arguments:e.args,API:t,locateFile:s(o=>e.indexURL+o,"locateFile"),instantiateWasm:me(e.indexURL)};return r}s(ce,"createSettings");function le(e){return function(t){let r="/";try{t.FS.mkdirTree(e)}catch(o){console.error(`Error occurred while making a home directory '${e}':`),console.error(o),console.error(`Using '${r}' for a home directory instead`),e=r}t.FS.chdir(e)}}s(le,"createHomeDirectory");function de(e){return function(t){Object.assign(t.ENV,e)}}s(de,"setEnvironment");function pe(e){return e?[async t=>{t.addRunDependency("fsInitHook");try{await e(t.FS,{sitePackages:t.API.sitePackages})}finally{t.removeRunDependency("fsInitHook")}}]:[]}s(pe,"callFsInitHook");function ue(e){let t=e.HEAPU32[e._Py_Version>>>2],r=t>>>24&255,o=t>>>16&255,a=t>>>8&255;return[r,o,a]}s(ue,"computeVersionTuple");function fe(e){let t=te(e);return async r=>{r.API.pyVersionTuple=ue(r);let[o,a]=r.API.pyVersionTuple;r.FS.mkdirTree("/lib"),r.API.sitePackages=`/lib/python${o}.${a}/site-packages`,r.FS.mkdirTree(r.API.sitePackages),r.addRunDependency("install-stdlib");try{let n=await t;r.FS.writeFile(`/lib/python${o}${a}.zip`,n)}catch(n){console.error("Error occurred while installing the standard library:"),console.error(n)}finally{r.removeRunDependency("install-stdlib")}}}s(fe,"installStdlib");function ye(e){let t;return e.stdLibURL!=null?t=e.stdLibURL:t=e.indexURL+"python_stdlib.zip",[fe(t),le(e.env.HOME),de(e.env),ae,...pe(e.fsInit)]}s(ye,"getFileSystemInitializationFuncs");function me(e){if(typeof WasmOffsetConverter<"u")return;let{binary:t,response:r}=T(e+"pyodide.asm.wasm"),o=se();return function(a,n){return(async function(){a.sentinel=await o;try{let i;r?i=await WebAssembly.instantiateStreaming(r,a):i=await WebAssembly.instantiate(await t,a);let{instance:c,module:l}=i;n(c,l)}catch(i){console.warn("wasm instantiation failed!"),console.warn(i)}})(),{}}}s(me,"getInstantiateWasmFunc");var De="0.29.2";function R(e){return e===void 0||e.endsWith("/")?e:e+"/"}s(R,"withTrailingSlash");var U=De;async function ge(e={}){if(await W(),e.lockFileContents&&e.lockFileURL)throw new Error("Can't pass both lockFileContents and lockFileURL");let t=e.indexURL||await ne();if(t=R(C(t)),e.packageBaseUrl=R(e.packageBaseUrl),e.cdnUrl=R(e.packageBaseUrl??`https://cdn.jsdelivr.net/pyodide/v${U}/full/`),!e.lockFileContents){let a=e.lockFileURL??t+"pyodide-lock.json";e.lockFileContents=ie(a),e.packageBaseUrl??=oe(a)}e.indexURL=t,e.packageCacheDir&&(e.packageCacheDir=R(C(e.packageCacheDir)));let r={fullStdLib:!1,jsglobals:globalThis,stdin:globalThis.prompt?()=>globalThis.prompt():void 0,args:[],env:{},packages:[],packageCacheDir:e.packageBaseUrl,enableRunUntilComplete:!0,checkAPIVersion:!0,BUILD_ID:"02af97d1069c4309880e46f2948861ea1faae5dbb49c20d5d5970aa9ae912fd4"},o=Object.assign(r,e);return o.env.HOME??="/home/pyodide",o.env.PYTHONINSPECT??="1",o}s(ge,"initializeConfiguration");function he(e){let t=ce(e),r=t.API;return r.lockFilePromise=Promise.resolve(e.lockFileContents),t}s(he,"createEmscriptenSettings");async function Ee(e){if(typeof _createPyodideModule!="function"){let t=`${e.indexURL}pyodide.asm.js`;await A(t)}}s(Ee,"loadWasmScript");async function be(e,t){if(!e._loadSnapshot)return;let r=await e._loadSnapshot,o=ArrayBuffer.isView(r)?r:new Uint8Array(r);return t.noInitialRun=!0,t.INITIAL_MEMORY=o.length,o}s(be,"prepareSnapshot");async function we(e){let t=await _createPyodideModule(e);if(e.exitCode!==void 0)throw new t.ExitStatus(e.exitCode);return t}s(we,"createPyodideModule");function _e(e,t){let r=e.API;if(t.pyproxyToStringRepr&&r.setPyProxyToStringMethod(!0),t.convertNullToNone&&r.setCompatNullToNone(!0),t.toJsLiteralMap&&r.setCompatToJsLiteralMap(!0),r.version!==U&&t.checkAPIVersion)throw new Error(`Pyodide version does not match: '${U}' <==> '${r.version}'. If you updated the Pyodide version, make sure you also updated the 'indexURL' parameter passed to loadPyodide.`);e.locateFile=o=>{throw o.endsWith(".so")?new Error(`Failed to find dynamic library "${o}"`):new Error(`Unexpected call to locateFile("${o}")`)}}s(_e,"configureAPI");function Se(e,t,r){let o=e.API,a;return t&&(a=o.restoreSnapshot(t)),o.finalizeBootstrap(a,r._snapshotDeserializer)}s(Se,"bootstrapPyodide");async function ke(e,t){let r=e._api;return r.sys.path.insert(0,""),r._pyodide.set_excepthook(),await r.packageIndexReady,r.initializeStreams(t.stdin,t.stdout,t.stderr),e}s(ke,"finalizeSetup");async function B(e={}){let t=await ge(e),r=he(t);await Ee(t);let o=await be(t,r),a=await we(r);_e(a,t);let n=Se(a,o,t);return await ke(n,t)}s(B,"loadPyodide");var p,P,Ie=new Uint8Array(new SharedArrayBuffer(1)),g;addEventListener("message",async e=>{let t=e.data;if(typeof t=="string")try{t=JSON.parse(t)}catch{}let{type:r,id:o,payload:a}=t;if(r==="RAW_IO"){postMessage({type:"RAW_IO",id:g,payload:a});return}if(r==="RAW_IO_RESPONSE"){if(p)try{let n=p.pyimport("web_bridge"),i=t.payload;n.handle_io_response(i.request_id,i.data)}catch(n){console.error("Error routing IO response to Python:",n)}return}if(r==="USER_INTERACTION_RESPONSE"){if(p)try{let n=p.pyimport("web_bridge"),i=t.payload;n.handle_interaction_response(i.request_id,i.value)}catch(n){console.error("Error routing interaction response to Python:",n)}return}if(r==="INTERRUPT"){Ie[0]=2;return}try{switch(r){case"INIT":await xe(o);break;case"PUSH":case"EXEC":if(!p||!P)throw new Error("Pyodide not initialized");g=o;try{let{code:n}=a;await Ue(o,n)}finally{g=void 0}break;case"PLR_COMMAND":postMessage({type:"PLR_COMMAND",id:g,payload:a});break;case"WELL_STATE_UPDATE":postMessage({type:"WELL_STATE_UPDATE",id:g,payload:a});break;case"FUNCTION_CALL_LOG":postMessage({type:"FUNCTION_CALL_LOG",id:g,payload:a});break;case"USER_INTERACTION":postMessage({type:"USER_INTERACTION",id:g,payload:a});break;case"INSTALL":if(!p)throw new Error("Pyodide not initialized");g=o;try{let n=p.pyimport("micropip"),i=a.packages;await n.install(i),postMessage({type:"INSTALL_COMPLETE",id:o})}finally{g=void 0}break;case"COMPLETE":if(!p||!P)throw new Error("Pyodide not initialized");try{let{code:n}=a,i=P.complete(n),c=i.toJs();i.destroy();let d=(c[0]||[]).map(u=>({name:u,type:"unknown",description:""}));postMessage({type:"COMPLETE_RESULT",id:o,payload:{matches:d}})}catch(n){console.error("Completion error:",n),postMessage({type:"COMPLETE_RESULT",id:o,payload:{matches:[]}})}break;case"SIGNATURES":if(!p)throw new Error("Pyodide not initialized");try{let n=p.pyimport("web_bridge"),{code:i}=a,c=n.get_signatures(i),l=c.toJs();c.destroy(),postMessage({type:"SIGNATURE_RESULT",id:o,payload:{signatures:l}})}catch{postMessage({type:"SIGNATURE_RESULT",id:o,payload:{signatures:[]}})}break;case"EXECUTE_BLOB":if(!p)throw new Error("Pyodide not initialized");g=o;try{let{blob:n,machine_config:i,deck_setup_script:c}=a;self.protocol_bytes=new Uint8Array(n),self.machine_config=i,self.deck_setup_script=c||"",await p.runPythonAsync(`
import cloudpickle
import js
import inspect
import sys
from web_bridge import create_configured_backend, create_browser_deck

# Load function from bytes
protocol_bytes = bytes(js.protocol_bytes)
protocol_func = cloudpickle.loads(protocol_bytes)

# Inspect signature to inject arguments
sig = inspect.signature(protocol_func)
kwargs = {}

# Get config from JS
config_proxy = js.machine_config

if 'backend' in sig.parameters:
    # Pass the proxy directly, the python function handles conversion
    kwargs['backend'] = create_configured_backend(config_proxy)

# Setup Deck
deck = None
try:
    if js.deck_setup_script:
        # Run the serialized deck setup script
        print("[Browser] Running deck setup script...")
        setup_ns = {}
        exec(js.deck_setup_script, setup_ns)
        if 'deck' in setup_ns:
            deck = setup_ns['deck']
        else:
            print("Warning: 'deck' variable not found in setup script.", file=sys.stderr)
            deck = create_browser_deck()
    else:
        # Fallback to default empty deck
        deck = create_browser_deck()
except Exception as e:
    print(f"Error during deck setup: {e}", file=sys.stderr)
    deck = create_browser_deck()

if 'deck' in sig.parameters:
    if deck is not None:
        kwargs['deck'] = deck
    else:
        print("Warning: 'deck' argument requested but Deck could not be instantiated.", file=sys.stderr)

# Execute
async def run_wrapper():
    if inspect.iscoroutinefunction(protocol_func):
        await protocol_func(**kwargs)
    else:
        # Check if it returns a coroutine (e.g. if it was decorated)
        result = protocol_func(**kwargs)
        if inspect.isawaitable(result):
            await result

await run_wrapper()
          `)}finally{g=void 0,postMessage({type:"EXEC_COMPLETE",id:o,payload:null})}break}}catch(n){postMessage({type:"ERROR",id:o,payload:n.message||String(n)})}});self.handlePythonOutput=(e,t)=>{console.log(`[Python ${e}]: ${t}`),g&&postMessage({type:e,id:g,payload:t})};async function xe(e){p=await B({indexURL:"/assets/pyodide/",lockFileURL:"https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide-lock.json"}),p.setInterruptBuffer(Ie),await p.loadPackage("micropip");try{await p.pyimport("micropip").install(["jedi","pylabrobot","cloudpickle"]),console.log("PyLabRobot and Jedi installed successfully")}catch(i){console.error("Failed to install PyLabRobot/Jedi:",i)}let t=[{file:"web_serial_shim.py",name:"WebSerial"},{file:"web_usb_shim.py",name:"WebUSB"},{file:"web_ftdi_shim.py",name:"WebFTDI"},{file:"web_hid_shim.py",name:"WebHID"}];for(let i of t)try{let c=await fetch(`assets/shims/${i.file}`);if(c.ok){let l=await c.text();p.FS.writeFile(i.file,l),console.log(`${i.name} Shim loaded successfully`)}else console.error(`Failed to fetch ${i.name} Shim:`,c.statusText)}catch(c){console.error(`Error loading ${i.name} Shim:`,c)}try{let i=p.FS.readdir(".");console.log("Pyodide FS root files:",i.filter(c=>c.endsWith(".py")))}catch(i){console.warn("Could not list FS:",i)}let o=await(await fetch("assets/python/web_bridge.py")).text();p.FS.writeFile("web_bridge.py",o);try{p.FS.mkdir("praxis");let c=await(await fetch("assets/python/praxis/__init__.py")).text();p.FS.writeFile("praxis/__init__.py",c);let d=await(await fetch("assets/python/praxis/interactive.py")).text();p.FS.writeFile("praxis/interactive.py",d),console.log("Praxis package loaded successfully")}catch(i){console.error("Error loading praxis package:",i)}P=await p.runPythonAsync(`
from pyodide.console import PyodideConsole
import js
import sys

def stdout_callback(s):
    # Use the exposed JS handler
    js.handlePythonOutput("STDOUT", s)

def stderr_callback(s):
    js.handlePythonOutput("STDERR", s)

# Create console with our callbacks
console = PyodideConsole(
    stdout_callback=stdout_callback,
    stderr_callback=stderr_callback
)

# Import web_bridge to make it available
import web_bridge

# Bootstrap the Playground environment (redirects sys.stdout/stderr, auto-imports)
web_bridge.bootstrap_playground(console.globals)

console
`);try{let i=`
import builtins
print(f"SCOPE CHECK: WebSerial in builtins: {hasattr(builtins, 'WebSerial')}")
print(f"SCOPE CHECK: WebUSB in builtins: {hasattr(builtins, 'WebUSB')}")
print(f"SCOPE CHECK: WebFTDI in builtins: {hasattr(builtins, 'WebFTDI')}")
print(f"SCOPE CHECK: WebHID in builtins: {hasattr(builtins, 'WebHID')}")

# Verify FTDI patching (critical for CLARIOstarBackend)
try:
    import pylabrobot.io.ftdi as _ftdi
    print(f"SCOPE CHECK: pylabrobot.io.ftdi.FTDI = {_ftdi.FTDI}")
    print(f"SCOPE CHECK: FTDI is WebFTDI? {'WebFTDI' in str(_ftdi.FTDI)}")
except Exception as e:
    print(f"SCOPE CHECK: FTDI check failed: {e}")

# Verify HID patching (critical for Inheco)
try:
    import pylabrobot.io.hid as _hid
    print(f"SCOPE CHECK: pylabrobot.io.hid.HID = {_hid.HID}")
    print(f"SCOPE CHECK: HID is WebHID? {'WebHID' in str(_hid.HID)}")
except Exception as e:
    print(f"SCOPE CHECK: HID check failed: {e}")
    `.trim();P.push(i)}catch(i){console.warn("Scope check failed:",i)}postMessage({type:"INIT_COMPLETE",id:e})}async function Ue(e,t){let r=t.split(`
`);for(let o=0;o<r.length;o++){let a=r[o];try{let n=P.push(a),i=n.syntax_check;if(i==="syntax-error"){n.destroy();break}if(i==="complete"){let c=await n;if(c!=null){let l=String(c);l&&l!=="None"&&l!=="undefined"&&postMessage({type:"STDOUT",id:e,payload:l+`
`})}typeof c?.destroy=="function"&&c.destroy()}n.destroy()}catch(n){console.error("Execution error:",n);let i="";try{let l=p.runPython(`
import sys
import traceback
_tb = traceback.format_exc()
# If no exception is active, format_exc returns 'NoneType: None\\n'
_tb if _tb and _tb.strip() != 'NoneType: None' else str(sys.exc_info()[1]) if sys.exc_info()[1] else ''
`);i=String(l),typeof l?.destroy=="function"&&l.destroy()}catch{i=""}(!i||i.trim()==="")&&(i=String(n)),postMessage({type:"STDERR",id:e,payload:i+`
`})}}postMessage({type:"EXEC_COMPLETE",id:e,payload:null})}
