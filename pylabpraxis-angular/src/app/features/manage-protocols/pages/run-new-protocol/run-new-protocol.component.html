<div class="run-protocol-container">
  <h1 class="page-title">Run New Protocol</h1>

  <mat-stepper linear #stepper="matStepper" orientation="vertical">
    <mat-step [stepControl]="protocolSelectionForm" label="Select Protocol">
      <form [formGroup]="protocolSelectionForm" class="step-form">
        <mat-form-field appearance="fill">
          <mat-label>Choose a Protocol</mat-label>
          <mat-select formControlName="protocolPath">
            <mat-option *ngFor="let protocol of discoveredProtocols" [value]="protocol.path">
              {{ protocol.name }} <small>({{ protocol.path }})</small>
            </mat-option>
          </mat-select>
          <mat-error *ngIf="protocolSelectionForm.get('protocolPath')?.hasError('required')">
            Protocol selection is required.
          </mat-error>
        </mat-form-field>
        <div class="stepper-buttons">
          <button mat-raised-button color="primary" matStepperNext
            [disabled]="!protocolSelectionForm.valid || isLoadingDetails">
            Next
            <mat-icon *ngIf="!isLoadingDetails">arrow_forward</mat-icon>
            <mat-progress-spinner *ngIf="isLoadingDetails" mode="indeterminate" diameter="20"
              style="margin-left: 8px;"></mat-progress-spinner>
          </button>
        </div>
      </form>
      <div *ngIf="isLoadingProtocols" class="loading-indicator">
        <mat-progress-spinner mode="indeterminate" diameter="30"></mat-progress-spinner>
        <span>Loading available protocols...</span>
      </div>
    </mat-step>

    <mat-step [stepControl]="parameterForm" label="Configure Parameters"
      *ngIf="selectedProtocol && selectedProtocol.has_parameters">
      <form [formGroup]="parameterForm" *ngIf="selectedProtocol" class="step-form dynamic-form">
        <h3 class="form-section-title">Protocol Parameters for: {{ selectedProtocol.name }}</h3>
        <p *ngIf="!getParameterKeys(selectedProtocol.parameters).length">This protocol has no configurable parameters.
        </p>

        <div *ngFor="let paramName of getParameterKeys(selectedProtocol.parameters)" class="form-field-container">
          <ng-container [ngSwitch]="getParamConfig(paramName)?.type">
            <mat-form-field appearance="fill" *ngSwitchCase="'string'">
              <mat-label>{{ paramName }}</mat-label>
              <input matInput [formControlName]="paramName"
                [placeholder]="getParamConfig(paramName)?.description || ''">
              <mat-hint *ngIf="getParamConfig(paramName)?.description">{{ getParamConfig(paramName)?.description
                }}</mat-hint>
              <mat-error *ngIf="parameterForm.get(paramName)?.hasError('required')">This field is required.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngSwitchCase="'integer'">
              <mat-label>{{ paramName }}</mat-label>
              <input matInput type="number" [formControlName]="paramName"
                [placeholder]="getParamConfig(paramName)?.description || ''">
              <mat-hint *ngIf="getParamConfig(paramName)?.description">{{ getParamConfig(paramName)?.description
                }}</mat-hint>
              <mat-error *ngIf="parameterForm.get(paramName)?.hasError('required')">This field is required.</mat-error>
            </mat-form-field>
            <mat-form-field appearance="fill" *ngSwitchCase="'float'">
              <mat-label>{{ paramName }}</mat-label>
              <input matInput type="number" step="any" [formControlName]="paramName"
                [placeholder]="getParamConfig(paramName)?.description || ''">
              <mat-hint *ngIf="getParamConfig(paramName)?.description">{{ getParamConfig(paramName)?.description
                }}</mat-hint>
              <mat-error *ngIf="parameterForm.get(paramName)?.hasError('required')">This field is required.</mat-error>
            </mat-form-field>
            <mat-form-field appearance="fill" *ngSwitchCase="'number'"> <mat-label>{{ paramName }}</mat-label>
              <input matInput type="number" step="any" [formControlName]="paramName"
                [placeholder]="getParamConfig(paramName)?.description || ''">
              <mat-hint *ngIf="getParamConfig(paramName)?.description">{{ getParamConfig(paramName)?.description
                }}</mat-hint>
              <mat-error *ngIf="parameterForm.get(paramName)?.hasError('required')">This field is required.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngSwitchCase="'boolean'">
              <mat-label>{{ paramName }}</mat-label>
              <mat-select [formControlName]="paramName">
                <mat-option [value]="true">True</mat-option>
                <mat-option [value]="false">False</mat-option>
              </mat-select>
              <mat-hint *ngIf="getParamConfig(paramName)?.description">{{ getParamConfig(paramName)?.description
                }}</mat-hint>
              <mat-error *ngIf="parameterForm.get(paramName)?.hasError('required')">This field is required.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngSwitchCase="'array'">
              <mat-label>{{ paramName }} (comma-separated)</mat-label>
              <input matInput [formControlName]="paramName"
                [placeholder]="getParamConfig(paramName)?.description || 'e.g., item1,item2,item3'">
              <mat-hint *ngIf="getParamConfig(paramName)?.description">{{ getParamConfig(paramName)?.description
                }}</mat-hint>
              <mat-error *ngIf="parameterForm.get(paramName)?.hasError('required')">This field is required.</mat-error>
            </mat-form-field>

            <mat-form-field appearance="fill" *ngSwitchCase="'dict'">
              <mat-label>{{ paramName }} (JSON string)</mat-label>
              <textarea matInput cdkTextareaAutosize #autosize="cdkTextareaAutosize" [formControlName]="paramName"
                [placeholder]="getParamConfig(paramName)?.description || ''"></textarea>
              <mat-hint *ngIf="getParamConfig(paramName)?.description">{{ getParamConfig(paramName)?.description
                }}</mat-hint>
              <mat-error *ngIf="parameterForm.get(paramName)?.hasError('required')">This field is required.</mat-error>
            </mat-form-field>


            <mat-form-field appearance="fill" *ngSwitchDefault>
              <mat-label>{{ paramName }} (Type: {{ getParamConfig(paramName)?.type }})</mat-label>
              <input matInput [formControlName]="paramName"
                [placeholder]="getParamConfig(paramName)?.description || ''">
              <mat-hint *ngIf="getParamConfig(paramName)?.description">{{ getParamConfig(paramName)?.description
                }}</mat-hint>
              <mat-error *ngIf="parameterForm.get(paramName)?.hasError('required')">This field is required.</mat-error>
            </mat-form-field>
          </ng-container>
        </div>

        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="primary" matStepperNext [disabled]="!parameterForm.valid">Next</button>
        </div>
      </form>
      <div *ngIf="selectedProtocol && !selectedProtocol.has_parameters" class="no-content-message">
        <p>This protocol does not require parameter configuration.</p>
        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="primary" matStepperNext>Next</button>
        </div>
      </div>
    </mat-step>

    <mat-step [stepControl]="assetForm" label="Assign Assets" *ngIf="selectedProtocol && selectedProtocol.has_assets">
      <form [formGroup]="assetForm" *ngIf="selectedProtocol" class="step-form dynamic-form">
        <h3 class="form-section-title">Asset Assignments for: {{ selectedProtocol.name }}</h3>
        <p *ngIf="!getAssetNames(selectedProtocol.assets).length">This protocol has no configurable assets.</p>

        <div *ngFor="let assetName of getAssetNames(selectedProtocol.assets)" class="form-field-container">
          <mat-form-field appearance="fill">
            <mat-label>{{ assetName }} (Type: {{ getAssetConfig(assetName)?.type }})</mat-label>
            <input matInput [formControlName]="assetName"
              [placeholder]="getAssetConfig(assetName)?.description || 'Enter assigned asset ID/Name'">
            <mat-hint *ngIf="getAssetConfig(assetName)?.description">{{ getAssetConfig(assetName)?.description
              }}</mat-hint>
            <mat-error *ngIf="assetForm.get(assetName)?.hasError('required') && getAssetConfig(assetName)?.required">
              This asset is required.
            </mat-error>
          </mat-form-field>
        </div>
        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="primary" matStepperNext [disabled]="!assetForm.valid">Next</button>
        </div>
      </form>
      <div *ngIf="selectedProtocol && !selectedProtocol.has_assets" class="no-content-message">
        <p>This protocol does not require asset configuration.</p>
        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="primary" matStepperNext>Next</button>
        </div>
      </div>
    </mat-step>

    <mat-step [stepControl]="deckForm" label="Configure Deck Layout">
      <form [formGroup]="deckForm" class="step-form">
        <h3 class="form-section-title">Deck Layout</h3>
        <p>Select an existing deck layout or upload a new one.</p>

        <mat-form-field appearance="fill">
          <mat-label>Choose Existing Deck Layout</mat-label>
          <mat-select formControlName="selectedDeckLayout" (selectionChange)="onDeckSelectionChange($event)">
            <mat-option *ngFor="let layout of deckLayouts" [value]="layout">
              {{ layout }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="file-upload-section">
          <label for="deck-file-input" class="file-upload-label">Or Upload New Deck File (JSON):</label>
          <input id="deck-file-input" type="file" (change)="onDeckFileSelected($event)" accept=".json">
          <span *ngIf="uploadedDeckFile" class="file-name">{{ uploadedDeckFile.name }}</span>
        </div>

        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="primary" matStepperNext>Next</button>
        </div>
      </form>
    </mat-step>


    <mat-step label="Review and Prepare">
      <div *ngIf="selectedProtocol" class="review-section">
        <h3 class="form-section-title">Review Configuration: {{ selectedProtocol.name }}</h3>
        <mat-card appearance="outlined">
          <mat-card-header>
            <mat-card-title>Selected Protocol</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <p><strong>Name:</strong> {{ selectedProtocol.name }}</p>
            <p><strong>Path:</strong> {{ selectedProtocol.path }}</p>
            <p><strong>Description:</strong> {{ selectedProtocol.description }}</p>
          </mat-card-content>
        </mat-card>

        <mat-card appearance="outlined"
          *ngIf="selectedProtocol.has_parameters && getParameterKeys(selectedProtocol.parameters).length > 0">
          <mat-card-header>
            <mat-card-title>Parameters</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <ul class="review-list">
              <li *ngFor="let paramName of getParameterKeys(parameterForm.value)">
                <strong>{{ paramName }}:</strong> {{ parameterForm.value[paramName] }}
              </li>
            </ul>
          </mat-card-content>
        </mat-card>

        <mat-card appearance="outlined"
          *ngIf="selectedProtocol.has_assets && getAssetNames(selectedProtocol.assets).length > 0">
          <mat-card-header>
            <mat-card-title>Asset Assignments</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <ul class="review-list">
              <li *ngFor="let assetName of getAssetNames(assetForm.value)">
                <strong>{{ assetName }}:</strong> {{ assetForm.value[assetName] }}
              </li>
            </ul>
          </mat-card-content>
        </mat-card>

        <mat-card appearance="outlined" *ngIf="selectedDeckLayout || uploadedDeckFile">
          <mat-card-header>
            <mat-card-title>Deck Layout</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <p *ngIf="selectedDeckLayout"><strong>Selected:</strong> {{ selectedDeckLayout }}</p>
            <p *ngIf="uploadedDeckFile"><strong>Uploaded:</strong> {{ uploadedDeckFile.name }}</p>
          </mat-card-content>
        </mat-card>


        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="accent" (click)="prepareProtocol()" [disabled]="isPreparing">
            Prepare Protocol
            <mat-progress-spinner *ngIf="isPreparing" mode="indeterminate" diameter="20"
              style="margin-left: 8px;"></mat-progress-spinner>
          </button>
        </div>
      </div>
      <div *ngIf="!selectedProtocol" class="no-content-message">
        <p>Please select a protocol first.</p>
      </div>
    </mat-step>

    <mat-step label="Start Protocol">
      <div *ngIf="preparedConfig" class="start-section">
        <h3 class="form-section-title">Protocol Prepared and Validated</h3>
        <p>Configuration is ready. Click below to start the protocol execution.</p>
        <pre class="config-preview">{{ preparedConfig | json }}</pre>

        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back (to Review)</button>
          <button mat-raised-button color="primary" (click)="startProtocol()" [disabled]="isStarting">
            Start Protocol Execution
            <mat-progress-spinner *ngIf="isStarting" mode="indeterminate" diameter="20"
              style="margin-left: 8px;"></mat-progress-spinner>
          </button>
        </div>
      </div>
      <div *ngIf="!preparedConfig && selectedProtocol" class="no-content-message">
        <p>Protocol has not been prepared or preparation failed. Please go back and prepare the protocol.</p>
        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back (to Review)</button>
        </div>
      </div>
      <div *ngIf="!selectedProtocol" class="no-content-message">
        <p>Please select and configure a protocol first.</p>
      </div>
    </mat-step>

  </mat-stepper>
</div>