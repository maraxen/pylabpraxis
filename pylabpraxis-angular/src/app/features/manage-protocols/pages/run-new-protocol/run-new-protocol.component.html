<div class="run-protocol-container">
  <h1 class="page-title">Run New Protocol</h1>

  <mat-stepper linear #stepper="matStepper" orientation="vertical">
    <mat-step [stepControl]="protocolSelectionForm" label="Select Protocol">
      <form [formGroup]="protocolSelectionForm" class="step-form">
        <mat-form-field appearance="fill">
          <mat-label>Choose a Protocol</mat-label>
          <mat-select formControlName="protocolPath">
            <mat-option *ngFor="let protocol of discoveredProtocols" [value]="protocol.path">
              {{ protocol.name }} <small>({{ protocol.path }})</small>
            </mat-option>
          </mat-select>
          <mat-error *ngIf="protocolSelectionForm.get('protocolPath')?.hasError('required')">
            Protocol selection is required.
          </mat-error>
        </mat-form-field>
        <div class="stepper-buttons">
          <button mat-raised-button color="primary" matStepperNext
            [disabled]="!protocolSelectionForm.valid || isLoadingDetails">
            Next
            <mat-icon *ngIf="!isLoadingDetails">arrow_forward</mat-icon>
            <mat-progress-spinner *ngIf="isLoadingDetails" mode="indeterminate" diameter="20"
              style="margin-left: 8px;"></mat-progress-spinner>
          </button>
        </div>
      </form>
      <div *ngIf="isLoadingProtocols" class="loading-indicator">
        <mat-progress-spinner mode="indeterminate" diameter="30"></mat-progress-spinner>
        <span>Loading available protocols...</span>
      </div>
    </mat-step>

    <mat-step [stepControl]="parameterForm" label="Configure Parameters"
      *ngIf="selectedProtocol && selectedProtocol.has_parameters">
      <form [formGroup]="parameterForm"
        *ngIf="selectedProtocol && selectedProtocol.parameters && objectKeys(selectedProtocol.parameters).length > 0"
        class="step-form dynamic-form">
        <h3 class="form-section-title">Protocol Parameters for: {{ selectedProtocol.name }}</h3>

        <div *ngFor="let group of groupedParameters" class="parameter-group">
          <h4 class="parameter-group-title">{{ group.title }}</h4>
          <div *ngFor="let param of group.parameters" class="form-field-container">
            <ng-container [ngSwitch]="param.config.type">

              <mat-form-field appearance="outline" *ngSwitchCase="'string'">
                <mat-label>{{ param.name }}</mat-label>
                <input matInput [formControlName]="param.name" [placeholder]="param.config.description || ''">
                <mat-hint *ngIf="param.config.description">{{ param.config.description }}</mat-hint>
                <mat-error *ngIf="parameterForm.get(param.name)?.hasError('required')">This field is
                  required.</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" *ngSwitchCase="'integer'">
                <mat-label>{{ param.name }}</mat-label>
                <input matInput type="number" step="1" [formControlName]="param.name"
                  [placeholder]="param.config.description || ''" [min]="param.config.constraints?.min_value ?? null"
                  [max]="param.config.constraints?.max_value ?? null">
                <mat-hint *ngIf="param.config.description">{{ param.config.description }}</mat-hint>
                <mat-error *ngIf="parameterForm.get(param.name)?.hasError('required')">This field is
                  required.</mat-error>
                <mat-error *ngIf="parameterForm.get(param.name)?.hasError('min')">Must be at least
                  {{param.config.constraints?.min_value}}.</mat-error>
                <mat-error *ngIf="parameterForm.get(param.name)?.hasError('max')">Must be at most
                  {{param.config.constraints?.max_value}}.</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" *ngSwitchCase="'float'">
                <mat-label>{{ param.name }}</mat-label>
                <input matInput type="number" step="any" [formControlName]="param.name"
                  [placeholder]="param.config.description || ''" [min]="param.config.constraints?.min_value ?? null"
                  [max]="param.config.constraints?.max_value ?? null" [step]="param.config.constraints?.step || 'any'">
                <mat-hint *ngIf="param.config.description">{{ param.config.description }}</mat-hint>
                <mat-error *ngIf="parameterForm.get(param.name)?.hasError('required')">This field is
                  required.</mat-error>
                <mat-error *ngIf="parameterForm.get(param.name)?.hasError('min')">Must be at least
                  {{param.config.constraints?.min_value}}.</mat-error>
                <mat-error *ngIf="parameterForm.get(param.name)?.hasError('max')">Must be at most
                  {{param.config.constraints?.max_value}}.</mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline" *ngSwitchCase="'number'">
                <mat-label>{{ param.name }}</mat-label>
                <input matInput type="number" step="any" [formControlName]="param.name"
                  [placeholder]="param.config.description || ''" [min]="param.config.constraints?.min_value ?? null"
                  [max]="param.config.constraints?.max_value ?? null" [step]="param.config.constraints?.step || 'any'">
                <mat-hint *ngIf="param.config.description">{{ param.config.description }}</mat-hint>
                <mat-error *ngIf="parameterForm.get(param.name)?.hasError('required')">This field is
                  required.</mat-error>
                <mat-error *ngIf="parameterForm.get(param.name)?.hasError('min')">Must be at least
                  {{param.config.constraints?.min_value}}.</mat-error>
                <mat-error *ngIf="parameterForm.get(param.name)?.hasError('max')">Must be at most
                  {{param.config.constraints?.max_value}}.</mat-error>
              </mat-form-field>

              <div class="boolean-checkbox-container" *ngSwitchCase="'boolean'">
                <mat-checkbox [formControlName]="param.name" color="primary">
                  {{ param.name }}
                </mat-checkbox>
                <mat-hint *ngIf="param.config.description" class="checkbox-hint">{{ param.config.description
                  }}</mat-hint>
                <mat-error
                  *ngIf="parameterForm.get(param.name)?.hasError('required') && parameterForm.get(param.name)?.touched">This
                  selection is required.</mat-error>
              </div>


              <div *ngSwitchCase="'array'" class="dynamic-array-container" [formArrayName]="param.name">
                <div class="dynamic-list-header">
                  <h5 class="dynamic-list-title">{{ param.name }}</h5>
                  <button mat-mini-fab color="primary" type="button" (click)="addArrayItem(param.name, param.config)"
                    matTooltip="Add Item">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>
                <mat-hint *ngIf="param.config.description" class="dynamic-list-description">{{ param.config.description
                  }}</mat-hint>

                <div *ngFor="let itemControl of getArrayControls(param.name); let i = index" class="dynamic-list-item">
                  <mat-form-field appearance="outline" class="dynamic-list-item-field">
                    <mat-label>Item {{ i + 1 }}</mat-label>
                    <input matInput [formControlName]="i" [placeholder]="'Value for item ' + (i+1)"
                      [type]="param.config.constraints?.subvariables?.['0']?.type === 'number' || param.config.constraints?.subvariables?.['0']?.type === 'integer' || param.config.constraints?.subvariables?.['0']?.type === 'float' ? 'number' : 'text'">
                  </mat-form-field>
                  <button mat-icon-button color="warn" type="button" (click)="removeArrayItem(param.name, i)"
                    matTooltip="Remove Item">
                    <mat-icon>delete_outline</mat-icon>
                  </button>
                </div>
                <mat-error
                  *ngIf="parameterForm.get(param.name)?.hasError('required') && parameterForm.get(param.name)?.touched">
                  At least one item is required.
                </mat-error>
              </div>

              <div *ngSwitchCase="'dict'" class="dynamic-dict-container" [formArrayName]="param.name">
                <div class="dynamic-list-header">
                  <h5 class="dynamic-list-title">{{ param.name }}</h5>
                  <button mat-mini-fab color="primary" type="button" (click)="addDictItem(param.name, param.config)"
                    matTooltip="Add Key-Value Pair">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>
                <mat-hint *ngIf="param.config.description" class="dynamic-list-description">{{ param.config.description
                  }}</mat-hint>

                <div *ngFor="let pairControl of getDictControls(param.name); let i = index" [formGroupName]="i"
                  class="dynamic-dict-item">
                  <mat-form-field appearance="outline" class="dynamic-dict-key-field">
                    <mat-label>Key {{ i + 1 }}</mat-label>
                    <input matInput formControlName="key" placeholder="Enter key">
                    <mat-error *ngIf="toFormGroup(pairControl).get('key')?.hasError('required')">Key is
                      required.</mat-error>
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="dynamic-dict-value-field">
                    <mat-label>Value {{ i + 1 }}</mat-label>
                    <input matInput formControlName="value" placeholder="Enter value"
                      [type]="param.config.constraints?.value_constraints?.type === 'number' || param.config.constraints?.value_constraints?.type === 'integer' || param.config.constraints?.value_constraints?.type === 'float' ? 'number' : (param.config.constraints?.value_constraints?.type === 'boolean' ? 'text' : 'text')">
                    <mat-error *ngIf="toFormGroup(pairControl).get('value')?.hasError('required')">Value is
                      required.</mat-error>
                  </mat-form-field>
                  <button mat-icon-button color="warn" type="button" (click)="removeDictItem(param.name, i)"
                    matTooltip="Remove Key-Value Pair">
                    <mat-icon>delete_outline</mat-icon>
                  </button>
                </div>
                <mat-error
                  *ngIf="parameterForm.get(param.name)?.hasError('required') && parameterForm.get(param.name)?.touched">
                  At least one key-value pair is required.
                </mat-error>
              </div>

              <mat-form-field appearance="outline" *ngSwitchDefault>
                <mat-label>{{ param.name }} (Type: {{ param.config.type }})</mat-label>
                <input matInput [formControlName]="param.name" [placeholder]="param.config.description || ''">
                <mat-hint *ngIf="param.config.description">{{ param.config.description }}</mat-hint>
                <mat-error *ngIf="parameterForm.get(param.name)?.hasError('required')">This field is
                  required.</mat-error>
              </mat-form-field>
            </ng-container>
          </div>
        </div>

        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="primary" matStepperNext [disabled]="!parameterForm.valid">Next</button>
        </div>
      </form>
      <div
        *ngIf="selectedProtocol && (!selectedProtocol.parameters || objectKeys(selectedProtocol.parameters).length === 0)"
        class="no-content-message">
        <p>This protocol does not require parameter configuration.</p>
        <div class="stepper-buttons"> <button mat-button matStepperPrevious>Back</button> <button mat-raised-button
            color="primary" matStepperNext>Next</button> </div>
      </div>
    </mat-step>

    <mat-step [stepControl]="assetForm" label="Assign Assets" *ngIf="selectedProtocol && selectedProtocol.has_assets">
      <form [formGroup]="assetForm"
        *ngIf="selectedProtocol && isArray(selectedProtocol.assets) && selectedProtocol.assets.length > 0"
        class="step-form dynamic-form">
        <h3 class="form-section-title">Asset Assignments for: {{ selectedProtocol.name }}</h3>
        <div *ngFor="let asset of selectedProtocol.assets" class="form-field-container">
          <mat-form-field appearance="outline">
            <mat-label>{{ asset.name }} (Type: {{ asset.type }})</mat-label>
            <input matInput [formControlName]="asset.name"
              [placeholder]="asset.description || 'Enter assigned asset ID/Name'">
            <mat-hint *ngIf="asset.description">{{ asset.description }}</mat-hint>
            <mat-error *ngIf="assetForm.get(asset.name)?.hasError('required') && asset.required">
              This asset is required.
            </mat-error>
          </mat-form-field>
        </div>
        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="primary" matStepperNext [disabled]="!assetForm.valid">Next</button>
        </div>
      </form>
      <div *ngIf="selectedProtocol && (!isArray(selectedProtocol.assets) || selectedProtocol.assets.length === 0)"
        class="no-content-message">
        <p>This protocol does not require asset configuration or asset data is unavailable.</p>
        <div class="stepper-buttons"> <button mat-button matStepperPrevious>Back</button> <button mat-raised-button
            color="primary" matStepperNext>Next</button> </div>
      </div>
    </mat-step>

    <mat-step [stepControl]="deckForm" label="Configure Deck Layout">
      <form [formGroup]="deckForm" class="step-form">
        <h3 class="form-section-title">Deck Layout</h3>
        <p>Select an existing deck layout or upload a new one.</p>
        <mat-form-field appearance="outline">
          <mat-label>Choose Existing Deck Layout</mat-label>
          <mat-select formControlName="selectedDeckLayout" (selectionChange)="onDeckSelectionChange($event)">
            <mat-option *ngFor="let layout of deckLayouts" [value]="layout">
              {{ layout }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <div class="file-upload-section">
          <label for="deck-file-input" class="file-upload-label">Or Upload New Deck File (JSON):</label>
          <input id="deck-file-input" type="file" (change)="onDeckFileSelected($event)" accept=".json">
          <span *ngIf="uploadedDeckFile" class="file-name">{{ uploadedDeckFile.name }}</span>
        </div>
        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="primary" matStepperNext>Next</button>
        </div>
      </form>
    </mat-step>

    <mat-step label="Review and Prepare">
      <div *ngIf="selectedProtocol" class="review-section">
        <h3 class="form-section-title">Review Configuration: {{ selectedProtocol.name }}</h3>
        <mat-card appearance="outlined">
          <mat-card-header><mat-card-title>Selected Protocol</mat-card-title></mat-card-header>
          <mat-card-content>
            <p><strong>Name:</strong> {{ selectedProtocol.name }}</p>
            <p><strong>Path:</strong> {{ selectedProtocol.path }}</p>
            <p><strong>Description:</strong> {{ selectedProtocol.description }}</p>
          </mat-card-content>
        </mat-card>

        <mat-card appearance="outlined"
          *ngIf="selectedProtocol.has_parameters && objectKeys(parameterForm.controls).length > 0">
          <mat-card-header><mat-card-title>Parameters</mat-card-title></mat-card-header>
          <mat-card-content>
            <ul class="review-list">
              <li *ngFor="let paramName of objectKeys(prepareProtocolFormValues())">
                <ng-container
                  *ngIf="prepareProtocolFormValues()[paramName] !== '' && prepareProtocolFormValues()[paramName] !== null && (!isArray(prepareProtocolFormValues()[paramName]) || prepareProtocolFormValues()[paramName].length > 0)">
                  <strong>{{ paramName }}:</strong>
                  <ng-container
                    *ngIf="getParamConfig(paramName)?.type === 'dict' || getParamConfig(paramName)?.type === 'array'">
                    <pre>{{ prepareProtocolFormValues()[paramName] | json }}</pre>
                  </ng-container>
                  <ng-container
                    *ngIf="getParamConfig(paramName)?.type !== 'dict' && getParamConfig(paramName)?.type !== 'array'">
                    {{ prepareProtocolFormValues()[paramName] }}
                  </ng-container>
                </ng-container>
              </li>
            </ul>
          </mat-card-content>
        </mat-card>

        <mat-card appearance="outlined"
          *ngIf="selectedProtocol.has_assets && objectKeys(assetForm.controls).length > 0">
          <mat-card-header><mat-card-title>Asset Assignments</mat-card-title></mat-card-header>
          <mat-card-content>
            <ul class="review-list">
              <li *ngFor="let assetName of objectKeys(assetForm.value)">
                <ng-container *ngIf="assetForm.value[assetName]">
                  <strong>{{ assetName }}:</strong> {{ assetForm.value[assetName] }}
                </ng-container>
              </li>
            </ul>
          </mat-card-content>
        </mat-card>

        <mat-card appearance="outlined" *ngIf="selectedDeckLayout || uploadedDeckFile">
          <mat-card-header><mat-card-title>Deck Layout</mat-card-title></mat-card-header>
          <mat-card-content>
            <p *ngIf="selectedDeckLayout"><strong>Selected:</strong> {{ selectedDeckLayout }}</p>
            <p *ngIf="uploadedDeckFile"><strong>Uploaded:</strong> {{ uploadedDeckFile.name }}</p>
          </mat-card-content>
        </mat-card>

        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="accent" (click)="prepareProtocol()"
            [disabled]="isPreparing || !selectedProtocolPath || !parameterForm.valid">
            Prepare Protocol
            <mat-progress-spinner *ngIf="isPreparing" mode="indeterminate" diameter="20"
              style="margin-left: 8px;"></mat-progress-spinner>
          </button>
        </div>
      </div>
      <div *ngIf="!selectedProtocol" class="no-content-message">
        <p>Please select a protocol first.</p>
      </div>
    </mat-step>

    <mat-step label="Start Protocol">
      <div *ngIf="preparedConfig" class="start-section">
        <h3 class="form-section-title">Protocol Prepared and Validated</h3>
        <p>Configuration is ready. Click below to start the protocol execution.</p>
        <pre class="config-preview">{{ preparedConfig | json }}</pre>
        <div class="stepper-buttons">
          <button mat-button matStepperPrevious>Back (to Review)</button>
          <button mat-raised-button color="primary" (click)="startProtocol()" [disabled]="isStarting">
            Start Protocol Execution
            <mat-progress-spinner *ngIf="isStarting" mode="indeterminate" diameter="20"
              style="margin-left: 8px;"></mat-progress-spinner>
          </button>
        </div>
      </div>
      <div *ngIf="!preparedConfig && selectedProtocol" class="no-content-message">
        <p>Protocol has not been prepared. Please go back and prepare.</p>
        <div class="stepper-buttons"> <button mat-button matStepperPrevious>Back</button> </div>
      </div>
      <div *ngIf="!selectedProtocol" class="no-content-message">
        <p>Please select and configure a protocol first.</p>
      </div>
    </mat-step>
  </mat-stepper>
</div>