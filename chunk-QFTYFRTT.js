import{a as M,b as y}from"./chunk-PWVAMWZ2.js";import{t as F}from"./chunk-F4M4TAIC.js";import{Ga as S,Ka as A,Kb as P,Zc as I,ha as C,ma as v,ya as W}from"./chunk-ZXFVGPYG.js";import{a as d,b as m}from"./chunk-RNQFGQA5.js";var z=Symbol("");function H(o){return new Proxy(o,{has(e,t){return!!this.get(e,t,void 0)},get(e,t){let r=A(e);return!ee(r)||!(t in r)?(P(e[t])&&e[t][z]&&delete e[t],e[t]):(P(e[t])||(Object.defineProperty(e,t,{value:I(()=>e()[t]),configurable:!0}),e[t][z]=!0),H(e[t]))}})}var Z=[WeakSet,WeakMap,Promise,Date,Error,RegExp,ArrayBuffer,DataView,Function];function ee(o){if(o===null||typeof o!="object"||te(o))return!1;let e=Object.getPrototypeOf(o);if(e===Object.prototype)return!0;for(;e&&e!==Object.prototype;){if(Z.includes(e.constructor))return!1;e=Object.getPrototypeOf(e)}return e===Object.prototype}function te(o){return typeof o?.[Symbol.iterator]=="function"}var re=new WeakMap,h=Symbol("");function b(o,...e){let t=A(()=>$(o)),r=e.reduce((i,a)=>d(d({},i),typeof a=="function"?a(i):a),t),n=o[h],s=Reflect.ownKeys(o[h]);for(let i of Reflect.ownKeys(r))if(s.includes(i)){let a=i;t[a]!==r[a]&&n[a].set(r[a])}ne(o)}function $(o){let e=o[h];return Reflect.ownKeys(o[h]).reduce((t,r)=>{let n=e[r]();return m(d({},t),{[r]:n})},{})}function oe(o){return re.get(o[h])||[]}function ne(o){let e=oe(o);for(let t of e){let r=A(()=>$(o));t(r)}}function q(...o){let e=[...o],t=typeof e[0]=="function"?{}:e.shift(),r=e;return(()=>{class s{constructor(){let a=r.reduce((p,T)=>T(p),se()),{stateSignals:c,props:l,methods:u,hooks:f}=a,g=d(d(d({},c),l),u);this[h]=a[h];for(let p of Reflect.ownKeys(g))this[p]=g[p];let{onInit:w,onDestroy:k}=f;w&&w(),k&&v(W).onDestroy(k)}static \u0275fac=function(c){return new(c||s)};static \u0275prov=C({token:s,factory:s.\u0275fac,providedIn:t.providedIn||null})}return s})()}function se(){return{[h]:{},stateSignals:{},props:{},methods:{},hooks:{}}}function ie(o){return e=>{let t=o(d(d(d({[h]:e[h]},e.stateSignals),e.props),e.methods));return m(d({},e),{props:d(d({},e.props),t)})}}function J(o){return ie(e=>{let t=o(e);return Reflect.ownKeys(t).reduce((n,s)=>{let i=t[s];return m(d({},n),{[s]:P(i)?i:I(i)})},{})})}function Y(o){return e=>{let t=d(d(d({[h]:e[h]},e.stateSignals),e.props),e.methods),r=typeof o=="function"?o(t):o,n=(s,i)=>i?()=>{s&&s(),i(t)}:s;return m(d({},e),{hooks:{onInit:n(e.hooks.onInit,r.onInit),onDestroy:n(e.hooks.onDestroy,r.onDestroy)}})}}function D(o){return e=>{let t=o(d(d(d({[h]:e[h]},e.stateSignals),e.props),e.methods));return m(d({},e),{methods:d(d({},e.methods),t)})}}function B(o){return e=>{let t=typeof o=="function"?o():o,r=Reflect.ownKeys(t),n=e[h],s={};for(let i of r)n[i]=S(t[i]),s[i]=H(n[i]);return m(d({},e),{stateSignals:d(d({},e.stateSignals),s)})}}var ae="application/json",L=class{#r=[];#t;#o=!0;#l;#i=this.#b(console.info);#h=this.#b(console.warn);#e={enable:!0,callbackList:[],interval:5};#s;didInitialize=!1;authenticated=!1;loginRequired=!1;responseMode="fragment";responseType="code";flow="standard";timeSkew=null;redirectUri;silentCheckSsoRedirectUri;silentCheckSsoFallback=!0;pkceMethod="S256";enableLogging=!1;logoutMethod="GET";scope;messageReceiveTimeout=1e4;idToken;idTokenParsed;token;tokenParsed;refreshToken;refreshTokenParsed;clientId;sessionId;subject;authServerUrl;realm;realmAccess;resourceAccess;profile;userInfo;endpoints;tokenTimeoutHandle;onAuthSuccess;onAuthError;onAuthRefreshSuccess;onAuthRefreshError;onTokenExpired;onAuthLogout;onReady;onActionUpdate;constructor(e){if(typeof e!="string"&&!O(e))throw new Error("The 'Keycloak' constructor must be provided with a configuration object, or a URL to a JSON configuration file.");if(O(e)){let t="oidcProvider"in e?["clientId"]:["url","realm","clientId"];for(let r of t)if(!(r in e))throw new Error(`The configuration object is missing the required '${r}' property.`)}globalThis.isSecureContext||this.#h(`[KEYCLOAK] Keycloak JS must be used in a 'secure context' to function properly as it relies on browser APIs that are otherwise not available.
Continuing to run your application insecurely will lead to unexpected behavior and breakage.

For more information see: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts`),this.#s=e}init=async(e={})=>{if(this.didInitialize)throw new Error("A 'Keycloak' instance can only be initialized once.");this.didInitialize=!0,this.#l=pe();let t=["default","cordova","cordova-native"];if(typeof e.adapter=="string"&&t.includes(e.adapter)?this.#t=this.#f(e.adapter):typeof e.adapter=="object"?this.#t=e.adapter:"Cordova"in window||"cordova"in window?this.#t=this.#f("cordova"):this.#t=this.#f("default"),typeof e.useNonce<"u"&&(this.#o=e.useNonce),typeof e.checkLoginIframe<"u"&&(this.#e.enable=e.checkLoginIframe),e.checkLoginIframeInterval&&(this.#e.interval=e.checkLoginIframeInterval),e.onLoad==="login-required"&&(this.loginRequired=!0),e.responseMode)if(e.responseMode==="query"||e.responseMode==="fragment")this.responseMode=e.responseMode;else throw new Error("Invalid value for responseMode");if(e.flow){switch(e.flow){case"standard":this.responseType="code";break;case"implicit":this.responseType="id_token token";break;case"hybrid":this.responseType="code id_token token";break;default:throw new Error("Invalid value for flow")}this.flow=e.flow}if(typeof e.timeSkew=="number"&&(this.timeSkew=e.timeSkew),e.redirectUri&&(this.redirectUri=e.redirectUri),e.silentCheckSsoRedirectUri&&(this.silentCheckSsoRedirectUri=e.silentCheckSsoRedirectUri),typeof e.silentCheckSsoFallback=="boolean"&&(this.silentCheckSsoFallback=e.silentCheckSsoFallback),typeof e.pkceMethod<"u"){if(e.pkceMethod!=="S256"&&e.pkceMethod!==!1)throw new TypeError(`Invalid value for pkceMethod', expected 'S256' or false but got ${e.pkceMethod}.`);this.pkceMethod=e.pkceMethod}return typeof e.enableLogging=="boolean"&&(this.enableLogging=e.enableLogging),e.logoutMethod==="POST"&&(this.logoutMethod="POST"),typeof e.scope=="string"&&(this.scope=e.scope),typeof e.messageReceiveTimeout=="number"&&e.messageReceiveTimeout>0&&(this.messageReceiveTimeout=e.messageReceiveTimeout),await this.#_(),await this.#I(),await this.#E(e),this.onReady?.(this.authenticated),this.authenticated};#f(e){if(e==="default")return this.#v();if(e==="cordova")return this.#e.enable=!1,this.#S();if(e==="cordova-native")return this.#e.enable=!1,this.#U();throw new Error("invalid adapter type: "+e)}#v(){let e=t=>t?.redirectUri||this.redirectUri||globalThis.location.href;return{login:async t=>(window.location.assign(await this.createLoginUrl(t)),await new Promise(()=>{})),logout:async t=>{if((t?.logoutMethod??this.logoutMethod)==="GET"){window.location.replace(this.createLogoutUrl(t));return}let n=document.createElement("form");n.setAttribute("method","POST"),n.setAttribute("action",this.createLogoutUrl(t)),n.style.display="none";let s={id_token_hint:this.idToken,client_id:this.clientId,post_logout_redirect_uri:e(t)};for(let[i,a]of Object.entries(s)){let c=document.createElement("input");c.setAttribute("type","hidden"),c.setAttribute("name",i),c.setAttribute("value",a),n.appendChild(c)}document.body.appendChild(n),n.submit()},register:async t=>(window.location.assign(await this.createRegisterUrl(t)),await new Promise(()=>{})),accountManagement:async()=>{let t=this.createAccountUrl();if(typeof t<"u")window.location.href=t;else throw new Error("Not supported by the OIDC server");return await new Promise(()=>{})},redirectUri:e}}#S(){let e=(i,a,c)=>window.cordova&&window.cordova.InAppBrowser?window.cordova.InAppBrowser.open(i,a,c):window.open(i,a,c),t=i=>i&&i.cordovaOptions?Object.keys(i.cordovaOptions).reduce((a,c)=>(a[c]=i.cordovaOptions[c],a),{}):{},r=i=>Object.keys(i).reduce((a,c)=>(a.push(c+"="+i[c]),a),[]).join(","),n=i=>{let a=t(i);return a.location="no",i&&i.prompt==="none"&&(a.hidden="yes"),r(a)},s=()=>this.redirectUri||"http://localhost";return{login:async i=>{let a=n(i),c=await this.createLoginUrl(i),l=e(c,"_blank",a),u=!1,f=!1;function g(){f=!0,l.close()}return await new Promise((w,k)=>{l.addEventListener("loadstart",async p=>{if(p.url.indexOf(s())===0){let T=this.#a(p.url);try{await this.#c(T),w()}catch(x){k(x)}g(),u=!0}}),l.addEventListener("loaderror",async p=>{if(!u)if(p.url.indexOf(s())===0){let T=this.#a(p.url);try{await this.#c(T),w()}catch(x){k(x)}g(),u=!0}else k(new Error("Unable to process login.")),g()}),l.addEventListener("exit",function(p){f||k(new Error("User closed the login window."))})})},logout:async i=>{let a=this.createLogoutUrl(i),c=e(a,"_blank","location=no,hidden=yes,clearcache=yes"),l=!1;c.addEventListener("loadstart",u=>{u.url.indexOf(s())===0&&c.close()}),c.addEventListener("loaderror",u=>{u.url.indexOf(s())===0||(l=!0),c.close()}),await new Promise((u,f)=>{c.addEventListener("exit",()=>{l?f(new Error("User closed the login window.")):(this.clearToken(),u())})})},register:async i=>{let a=await this.createRegisterUrl(),c=n(i),l=e(a,"_blank",c);await new Promise((f,g)=>{l.addEventListener("loadstart",async w=>{if(w.url.indexOf(s())===0){l.close();let k=this.#a(w.url);try{await this.#c(k),f()}catch(p){g(p)}}})})},accountManagement:async()=>{let i=this.createAccountUrl();if(typeof i<"u"){let a=e(i,"_blank","location=no");a.addEventListener("loadstart",function(c){c.url.indexOf(s())===0&&a.close()})}else throw new Error("Not supported by the OIDC server")},redirectUri:()=>s()}}#U(){return{login:async e=>{let t=await this.createLoginUrl(e);await new Promise((r,n)=>{universalLinks.subscribe("keycloak",async s=>{universalLinks.unsubscribe("keycloak"),window.cordova.plugins.browsertab.close();let i=this.#a(s.url);try{await this.#c(i),r()}catch(a){n(a)}}),window.cordova.plugins.browsertab.openUrl(t)})},logout:async e=>{let t=this.createLogoutUrl(e);await new Promise(r=>{universalLinks.subscribe("keycloak",()=>{universalLinks.unsubscribe("keycloak"),window.cordova.plugins.browsertab.close(),this.clearToken(),r()}),window.cordova.plugins.browsertab.openUrl(t)})},register:async e=>{let t=await this.createRegisterUrl(e);await new Promise((r,n)=>{universalLinks.subscribe("keycloak",async s=>{universalLinks.unsubscribe("keycloak"),window.cordova.plugins.browsertab.close();let i=this.#a(s.url);try{await this.#c(i),r()}catch(a){n(a)}}),window.cordova.plugins.browsertab.openUrl(t)})},accountManagement:async()=>{let e=this.createAccountUrl();if(typeof e<"u")window.cordova.plugins.browsertab.openUrl(e);else throw new Error("Not supported by the OIDC server")},redirectUri:e=>e&&e.redirectUri?e.redirectUri:this.redirectUri?this.redirectUri:"http://localhost"}}async#_(){if(typeof this.#s=="string"){let e=await ye(this.#s);this.authServerUrl=e["auth-server-url"],this.realm=e.realm,this.clientId=e.resource,this.#g()}else this.clientId=this.#s.clientId,"oidcProvider"in this.#s?await this.#T(this.#s.oidcProvider):(this.authServerUrl=this.#s.url,this.realm=this.#s.realm,this.#g())}#g(){this.endpoints={authorize:()=>this.#n()+"/protocol/openid-connect/auth",token:()=>this.#n()+"/protocol/openid-connect/token",logout:()=>this.#n()+"/protocol/openid-connect/logout",checkSessionIframe:()=>this.#n()+"/protocol/openid-connect/login-status-iframe.html",thirdPartyCookiesIframe:()=>this.#n()+"/protocol/openid-connect/3p-cookies/step1.html",register:()=>this.#n()+"/protocol/openid-connect/registrations",userinfo:()=>this.#n()+"/protocol/openid-connect/userinfo"}}async#T(e){if(typeof e=="string"){let t=`${Q(e)}/.well-known/openid-configuration`,r=await be(t);this.#k(r)}else this.#k(e)}#k(e){this.endpoints={authorize(){return e.authorization_endpoint},token(){return e.token_endpoint},logout(){if(!e.end_session_endpoint)throw new Error("Not supported by the OIDC server");return e.end_session_endpoint},checkSessionIframe(){if(!e.check_session_iframe)throw new Error("Not supported by the OIDC server");return e.check_session_iframe},register(){throw new Error('Redirection to "Register user" page not supported in standard OIDC mode')},userinfo(){if(!e.userinfo_endpoint)throw new Error("Not supported by the OIDC server");return e.userinfo_endpoint}}}async#I(){if(!this.#e.enable&&!this.silentCheckSsoRedirectUri||typeof this.endpoints.thirdPartyCookiesIframe!="function")return;let e=document.createElement("iframe");e.setAttribute("src",this.endpoints.thirdPartyCookiesIframe()),e.setAttribute("sandbox","allow-storage-access-by-user-activation allow-scripts allow-same-origin"),e.setAttribute("title","keycloak-3p-check-iframe"),e.style.display="none",document.body.appendChild(e);let t=new Promise(r=>{let n=s=>{e.contentWindow===s.source&&(s.data!=="supported"&&s.data!=="unsupported"||(s.data==="unsupported"&&(this.#h(`[KEYCLOAK] Your browser is blocking access to 3rd-party cookies, this means:

 - It is not possible to retrieve tokens without redirecting to the Keycloak server (a.k.a. no support for silent authentication).
 - It is not possible to automatically detect changes to the session status (such as the user logging out in another tab).

For more information see: https://www.keycloak.org/securing-apps/javascript-adapter#_modern_browsers`),this.#e.enable=!1,this.silentCheckSsoFallback&&(this.silentCheckSsoRedirectUri=void 0)),document.body.removeChild(e),window.removeEventListener("message",n),r()))};window.addEventListener("message",n,!1)});return await fe(t,this.messageReceiveTimeout,"Timeout when waiting for 3rd party check iframe message.")}async#E(e){let t=this.#a(window.location.href);if(t?.newUrl&&window.history.replaceState(window.history.state,"",t.newUrl),t&&t.valid){await this.#p(),await this.#c(t);return}let r=async s=>{let i={};s||(i.prompt="none"),e.locale&&(i.locale=e.locale),await this.login(i)},n=async()=>{switch(e.onLoad){case"check-sso":this.#e.enable?(await this.#p(),await this.#d()||(this.silentCheckSsoRedirectUri?await this.#w():await r(!1))):this.silentCheckSsoRedirectUri?await this.#w():await r(!1);break;case"login-required":await r(!0);break;default:throw new Error("Invalid value for onLoad")}};if(e.token&&e.refreshToken)if(this.#u(e.token,e.refreshToken,e.idToken),this.#e.enable)await this.#p(),await this.#d()&&(this.onAuthSuccess?.(),this.#m());else try{await this.updateToken(-1),this.onAuthSuccess?.()}catch(s){if(this.onAuthError?.(),e.onLoad)await n();else throw s}else e.onLoad&&await n()}async#p(){if(!this.#e.enable||this.#e.iframe)return;let e=document.createElement("iframe");this.#e.iframe=e,e.setAttribute("src",this.endpoints.checkSessionIframe()),e.setAttribute("sandbox","allow-storage-access-by-user-activation allow-scripts allow-same-origin"),e.setAttribute("title","keycloak-session-iframe"),e.style.display="none",document.body.appendChild(e);let t=n=>{if(n.origin!==this.#e.iframeOrigin||this.#e.iframe?.contentWindow!==n.source||!(n.data==="unchanged"||n.data==="changed"||n.data==="error"))return;n.data!=="unchanged"&&this.clearToken();let s=this.#e.callbackList;this.#e.callbackList=[];for(let i of s.reverse())n.data==="error"?i(new Error("Error while checking login iframe")):i(null,n.data==="unchanged")};window.addEventListener("message",t,!1),await new Promise(n=>{e.addEventListener("load",()=>{let s=this.endpoints.authorize();s.startsWith("/")?this.#e.iframeOrigin=globalThis.location.origin:this.#e.iframeOrigin=new URL(s).origin,n()})})}async#d(){if(!this.#e.iframe||!this.#e.iframeOrigin)return;let e=`${this.clientId} ${this.sessionId?this.sessionId:""}`,t=this.#e.iframeOrigin;return await new Promise((n,s)=>{let i=(a,c)=>a?s(a):n(c);this.#e.callbackList.push(i),this.#e.callbackList.length===1&&this.#e.iframe?.contentWindow?.postMessage(e,t)})}async#w(){let e=document.createElement("iframe"),t=await this.createLoginUrl({prompt:"none",redirectUri:this.silentCheckSsoRedirectUri});return e.setAttribute("src",t),e.setAttribute("sandbox","allow-storage-access-by-user-activation allow-scripts allow-same-origin"),e.setAttribute("title","keycloak-silent-check-sso"),e.style.display="none",document.body.appendChild(e),await new Promise((r,n)=>{let s=async i=>{if(i.origin!==window.location.origin||e.contentWindow!==i.source)return;let a=this.#a(i.data);try{await this.#c(a),r()}catch(c){n(c)}document.body.removeChild(e),window.removeEventListener("message",s)};window.addEventListener("message",s)})}#a(e){let t=this.#C(e);if(!t)return;let r=this.#l.get(t.state);return r&&(t.valid=!0,t.redirectUri=r.redirectUri,t.storedNonce=r.nonce,t.prompt=r.prompt,t.pkceCodeVerifier=r.pkceCodeVerifier,t.loginOptions=r.loginOptions),t}#C(e){let t=[];switch(this.flow){case"standard":t=["code","state","session_state","kc_action_status","kc_action","iss"];break;case"implicit":t=["access_token","token_type","id_token","state","session_state","expires_in","kc_action_status","kc_action","iss"];break;case"hybrid":t=["access_token","token_type","id_token","code","state","session_state","expires_in","kc_action_status","kc_action","iss"];break}t.push("error"),t.push("error_description"),t.push("error_uri");let r=new URL(e),n="",s;if(this.responseMode==="query"&&r.searchParams.size>0?(s=this.#y(r.search,t),r.search=s.paramsString,n=r.toString()):this.responseMode==="fragment"&&r.hash.length>0&&(s=this.#y(r.hash.substring(1),t),r.hash=s.paramsString,n=r.toString()),s?.oauthParams){if(this.flow==="standard"||this.flow==="hybrid"){if((s.oauthParams.code||s.oauthParams.error)&&s.oauthParams.state)return s.oauthParams.newUrl=n,s.oauthParams}else if(this.flow==="implicit"&&(s.oauthParams.access_token||s.oauthParams.error)&&s.oauthParams.state)return s.oauthParams.newUrl=n,s.oauthParams}}#y(e,t){let r=new URLSearchParams(e),n={};for(let[s,i]of Array.from(r.entries()))t.includes(s)&&(n[s]=i,r.delete(s));return{paramsString:r.toString(),oauthParams:n}}async#c(e){let{code:t,error:r,prompt:n}=e,s=new Date().getTime(),i=(a,c,l)=>{if(s=(s+new Date().getTime())/2,this.#u(a,c,l,s),this.#o&&this.idTokenParsed&&this.idTokenParsed.nonce!==e.storedNonce)throw this.#i("[KEYCLOAK] Invalid nonce, clearing token"),this.clearToken(),new Error("Invalid nonce.")};if(e.kc_action_status&&this.onActionUpdate&&this.onActionUpdate(e.kc_action_status,e.kc_action),r){if(n!=="none")if(e.error_description&&e.error_description==="authentication_expired")await this.login(e.loginOptions);else{let a={error:r,error_description:e.error_description};throw this.onAuthError?.(a),a}return}else this.flow!=="standard"&&(e.access_token||e.id_token)&&(i(e.access_token,void 0,e.id_token),this.onAuthSuccess?.());if(this.flow!=="implicit"&&t)try{let a=await ve(this.endpoints.token(),t,this.clientId,e.redirectUri,e.pkceCodeVerifier);i(a.access_token,a.refresh_token,a.id_token),this.flow==="standard"&&this.onAuthSuccess?.(),this.#m()}catch(a){throw this.onAuthError?.(),a}}async#m(){this.#e.enable&&this.token&&(await _e(this.#e.interval*1e3),await this.#d()&&await this.#m())}login=e=>this.#t.login(e);createLoginUrl=async e=>{let t=V(),r=V(),n=this.#t.redirectUri(e),s={state:t,nonce:r,redirectUri:n,loginOptions:e};e?.prompt&&(s.prompt=e.prompt);let i=e?.action==="register"?this.endpoints.register():this.endpoints.authorize(),a=e?.scope||this.scope,c=a?a.split(" "):[];c.includes("openid")||c.unshift("openid"),a=c.join(" ");let l=new URLSearchParams([["client_id",this.clientId],["redirect_uri",n],["state",t],["response_mode",this.responseMode],["response_type",this.responseType],["scope",a]]);if(this.#o&&l.append("nonce",r),e?.prompt&&l.append("prompt",e.prompt),typeof e?.maxAge=="number"&&l.append("max_age",e.maxAge.toString()),e?.loginHint&&l.append("login_hint",e.loginHint),e?.idpHint&&l.append("kc_idp_hint",e.idpHint),e?.action&&e.action!=="register"&&l.append("kc_action",e.action),e?.locale&&l.append("ui_locales",e.locale),e?.acr&&l.append("claims",ce(e.acr)),e?.acrValues&&l.append("acr_values",e.acrValues),this.pkceMethod)try{let u=le(96),f=await de(this.pkceMethod,u);s.pkceCodeVerifier=u,l.append("code_challenge",f),l.append("code_challenge_method",this.pkceMethod)}catch(u){throw new Error("Failed to generate PKCE challenge.",{cause:u})}return this.#l.add(s),`${i}?${l.toString()}`};logout=e=>this.#t.logout(e);createLogoutUrl=e=>{let t=e?.logoutMethod??this.logoutMethod,r=this.endpoints.logout();if(t==="POST")return r;let n=new URLSearchParams([["client_id",this.clientId],["post_logout_redirect_uri",this.#t.redirectUri(e)]]);return this.idToken&&n.append("id_token_hint",this.idToken),`${r}?${n.toString()}`};register=e=>this.#t.register(e);createRegisterUrl=e=>this.createLoginUrl(m(d({},e),{action:"register"}));createAccountUrl=e=>{let t=this.#n();if(!t)throw new Error("Unable to create account URL, make sure the adapter is not configured using a generic OIDC provider.");let r=new URLSearchParams([["referrer",this.clientId],["referrer_uri",this.#t.redirectUri(e)]]);return`${t}/account?${r.toString()}`};accountManagement=()=>this.#t.accountManagement();hasRealmRole=e=>{let t=this.realmAccess;return!!t&&t.roles.indexOf(e)>=0};hasResourceRole=(e,t)=>{if(!this.resourceAccess)return!1;let r=this.resourceAccess[t||this.clientId];return!!r&&r.roles.indexOf(e)>=0};loadUserProfile=async()=>{let e=this.#n();if(!e)throw new Error("Unable to load user profile, make sure the adapter is not configured using a generic OIDC provider.");let t=`${e}/account`,r=await _(t,{headers:[G(this.token)]});return this.profile=r};loadUserInfo=async()=>{let e=this.endpoints.userinfo(),t=await _(e,{headers:[G(this.token)]});return this.userInfo=t};isTokenExpired=e=>{if(!this.tokenParsed||!this.refreshToken&&this.flow!=="implicit")throw new Error("Not authenticated");if(this.timeSkew==null)return this.#i("[KEYCLOAK] Unable to determine if token is expired as timeskew is not set"),!0;if(typeof this.tokenParsed.exp!="number")return!1;let t=this.tokenParsed.exp-Math.ceil(new Date().getTime()/1e3)+this.timeSkew;if(e){if(isNaN(e))throw new Error("Invalid minValidity");t-=e}return t<0};updateToken=async e=>{if(!this.refreshToken)throw new Error("Unable to update token, no refresh token available.");e=e||5,this.#e.enable&&await this.#d();let t=!1;if(e===-1?(t=!0,this.#i("[KEYCLOAK] Refreshing token: forced refresh")):(!this.tokenParsed||this.isTokenExpired(e))&&(t=!0,this.#i("[KEYCLOAK] Refreshing token: token expired")),!t)return!1;let{promise:r,resolve:n,reject:s}=Promise.withResolvers();if(this.#r.push({resolve:n,reject:s}),this.#r.length===1){let i=this.endpoints.token(),a=new Date().getTime();try{let c=await Se(i,this.refreshToken,this.clientId);this.#i("[KEYCLOAK] Token refreshed"),a=(a+new Date().getTime())/2,this.#u(c.access_token,c.refresh_token,c.id_token,a),this.onAuthRefreshSuccess?.();for(let l=this.#r.pop();l!=null;l=this.#r.pop())l.resolve(!0)}catch(c){this.#h("[KEYCLOAK] Failed to refresh token"),c instanceof R&&c.response.status===400&&this.clearToken(),this.onAuthRefreshError?.();for(let l=this.#r.pop();l!=null;l=this.#r.pop())l.reject(c)}}return await r};clearToken=()=>{this.token&&(this.#u(),this.onAuthLogout?.(),this.loginRequired&&this.login())};#u(e,t,r,n){if(this.tokenTimeoutHandle&&(clearTimeout(this.tokenTimeoutHandle),this.tokenTimeoutHandle=void 0),t?(this.refreshToken=t,this.refreshTokenParsed=K(t)):(delete this.refreshToken,delete this.refreshTokenParsed),r?(this.idToken=r,this.idTokenParsed=K(r)):(delete this.idToken,delete this.idTokenParsed),e){if(this.token=e,this.tokenParsed=K(e),this.sessionId=this.tokenParsed.sid,this.authenticated=!0,this.subject=this.tokenParsed.sub,this.realmAccess=this.tokenParsed.realm_access,this.resourceAccess=this.tokenParsed.resource_access,n&&(this.timeSkew=Math.floor(n/1e3)-this.tokenParsed.iat),this.timeSkew!==null&&(this.#i("[KEYCLOAK] Estimated time difference between browser and server is "+this.timeSkew+" seconds"),this.onTokenExpired)){let s=(this.tokenParsed.exp-new Date().getTime()/1e3+this.timeSkew)*1e3;this.#i("[KEYCLOAK] Token expires in "+Math.round(s/1e3)+" s"),s<=0?this.onTokenExpired():this.tokenTimeoutHandle=window.setTimeout(this.onTokenExpired,s)}}else delete this.token,delete this.tokenParsed,delete this.subject,delete this.realmAccess,delete this.resourceAccess,this.authenticated=!1}#n(){if(!(typeof this.authServerUrl>"u"))return`${Q(this.authServerUrl)}/realms/${encodeURIComponent(this.realm)}`}#b(e){return t=>{this.enableLogging&&e.call(console,t)}}};function V(){if(typeof crypto>"u"||typeof crypto.randomUUID>"u")throw new Error("Web Crypto API is not available.");return crypto.randomUUID()}function ce(o){return JSON.stringify({id_token:{acr:o}})}function le(o){return ue(o,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789")}async function de(o,e){if(o!=="S256")throw new TypeError(`Invalid value for 'pkceMethod', expected 'S256' but got '${o}'.`);let t=new Uint8Array(await ge(e));return me(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function ue(o,e){let t=he(o),r=new Array(o);for(let n=0;n<o;n++)r[n]=e.charCodeAt(t[n]%e.length);return String.fromCharCode.apply(null,r)}function he(o){if(typeof crypto>"u"||typeof crypto.getRandomValues>"u")throw new Error("Web Crypto API is not available.");return crypto.getRandomValues(new Uint8Array(o))}function fe(o,e,t){let r,n=new Promise(function(s,i){r=window.setTimeout(function(){i(new Error(t||"Promise is not settled within timeout of "+e+"ms"))},e)});return Promise.race([o,n]).finally(function(){clearTimeout(r)})}function pe(){try{return new j}catch{return new N}}var U="kc-callback-",j=class{constructor(){globalThis.localStorage.setItem("kc-test","test"),globalThis.localStorage.removeItem("kc-test")}get(e){if(!e)return null;this.#r();let t=U+e,r=globalThis.localStorage.getItem(t);return r?(globalThis.localStorage.removeItem(t),JSON.parse(r)):null}add(e){this.#r();let t=U+e.state,r=JSON.stringify(m(d({},e),{expires:Date.now()+3600*1e3}));try{globalThis.localStorage.setItem(t,r)}catch{this.#t(),globalThis.localStorage.setItem(t,r)}}#r(){let e=Date.now();for(let[t,r]of this.#o()){let n=this.#l(r);(n===null||n<e)&&globalThis.localStorage.removeItem(t)}}#t(){for(let[e]of this.#o())globalThis.localStorage.removeItem(e)}#o(){return Object.entries(globalThis.localStorage).filter(([e])=>e.startsWith(U))}#l(e){let t;try{t=JSON.parse(e)}catch{return null}return O(t)&&"expires"in t&&typeof t.expires=="number"?t.expires:null}},N=class{get(e){if(!e)return null;let t=this.#r(U+e);return this.#t(U+e,"",this.#o(-100)),t?JSON.parse(t):null}add(e){this.#t(U+e.state,JSON.stringify(e),this.#o(60))}#r(e){let t=e+"=",r=document.cookie.split(";");for(let n=0;n<r.length;n++){let s=r[n];for(;s.charAt(0)===" ";)s=s.substring(1);if(s.indexOf(t)===0)return s.substring(t.length,s.length)}return""}#t(e,t,r){let n=e+"="+t+"; expires="+r.toUTCString()+"; ";document.cookie=n}#o(e){let t=new Date;return t.setTime(t.getTime()+e*60*1e3),t}};function me(o){let e=String.fromCodePoint(...o);return btoa(e)}async function ge(o){let t=new TextEncoder().encode(o);if(typeof crypto>"u"||typeof crypto.subtle>"u")throw new Error("Web Crypto API is not available.");return await crypto.subtle.digest("SHA-256",t)}function K(o){let[,e]=o.split(".");if(typeof e!="string")throw new Error("Unable to decode token, payload not found.");let t;try{t=ke(e)}catch(r){throw new Error("Unable to decode token, payload is not a valid Base64URL value.",{cause:r})}try{return JSON.parse(t)}catch(r){throw new Error("Unable to decode token, payload is not a valid JSON value.",{cause:r})}}function ke(o){let e=o.replaceAll("-","+").replaceAll("_","/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("Input is not of the correct length.")}try{return we(e)}catch{return atob(e)}}function we(o){return decodeURIComponent(atob(o).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function O(o){return typeof o=="object"&&o!==null}async function ye(o){return await _(o)}async function be(o){return await _(o)}async function ve(o,e,t,r,n){let s=new URLSearchParams([["code",e],["grant_type","authorization_code"],["client_id",t],["redirect_uri",r]]);return n&&s.append("code_verifier",n),await _(o,{method:"POST",credentials:"include",body:s})}async function Se(o,e,t){let r=new URLSearchParams([["grant_type","refresh_token"],["refresh_token",e],["client_id",t]]);return await _(o,{method:"POST",credentials:"include",body:r})}async function _(o,e={}){let t=new Headers(e.headers);return t.set("Accept",ae),await(await Ue(o,m(d({},e),{headers:t}))).json()}async function Ue(o,e){let t=await fetch(o,e);if(!t.ok)throw new R("Server responded with an invalid status.",{response:t});return t}function G(o){if(!o)throw new Error("Unable to build authorization header, token is not set, make sure the user is authenticated.");return["Authorization",`bearer ${o}`]}function Q(o){return o.endsWith("/")?o.slice(0,-1):o}var R=class extends Error{response;constructor(e,t){super(e,t),this.response=t.response}},_e=o=>new Promise(e=>setTimeout(e,o));var E=class o{keycloak=null;_isAuthenticated=S(!1);_user=S(null);_token=S(null);isAuthenticated=this._isAuthenticated.asReadonly();user=this._user.asReadonly();token=this._token.asReadonly();async init(e){if(y())return console.log("[KeycloakService] Browser mode detected - simulating authentication"),this._isAuthenticated.set(!0),this._user.set({id:"local-user",username:"local",email:"local@praxis.local",firstName:"Local",lastName:"User",roles:["user","browser-mode","admin"]}),this._token.set("local-token"),!0;this.keycloak=new L({url:M.keycloak.url,realm:M.keycloak.realm,clientId:M.keycloak.clientId});try{let t=new Promise((n,s)=>{setTimeout(()=>s(new Error("Keycloak initialization timed out")),1e4)}),r=await Promise.race([this.keycloak.init({onLoad:e?.onLoad||"check-sso",silentCheckSsoRedirectUri:window.location.origin+"/silent-check-sso.html",pkceMethod:"S256",checkLoginIframe:!1}),t]);return r&&(await this.updateUserState(),this.setupTokenRefresh()),this._isAuthenticated.set(r),r}catch(t){return console.error("Keycloak initialization failed:",t),this._isAuthenticated.set(!1),!1}}login(e){if(y())return console.log("[KeycloakService] Browser mode - login simulated"),this._isAuthenticated.set(!0),Promise.resolve();if(!this.keycloak)throw new Error("Keycloak not initialized");return this.keycloak.login({redirectUri:e||window.location.origin+"/app/home"})}register(e){if(y())return console.log("[KeycloakService] Browser mode - registration simulated"),Promise.resolve();if(!this.keycloak)throw new Error("Keycloak not initialized");return this.keycloak.register({redirectUri:e||window.location.origin+"/app/home"})}logout(e){if(this._isAuthenticated.set(!1),this._user.set(null),this._token.set(null),y())return console.log("[KeycloakService] Browser mode - logout simulated"),window.location.href="/",Promise.resolve();if(!this.keycloak)throw new Error("Keycloak not initialized");return this.keycloak.logout({redirectUri:e||window.location.origin})}async getToken(){if(y())return"local-token";if(!this.keycloak||!this.keycloak.authenticated)return null;try{return await this.keycloak.updateToken(30),this._token.set(this.keycloak.token||null),this.keycloak.token||null}catch(e){return console.error("Failed to refresh token:",e),this.login(),null}}hasRole(e){return y()?["user","browser-mode","admin"].includes(e):this.keycloak?.hasRealmRole(e)||!1}hasAnyRole(e){return e.some(t=>this.hasRole(t))}getAccountUrl(){return y()?"#":this.keycloak?.createAccountUrl()}async updateUserState(){if(!this.keycloak||!this.keycloak.authenticated){this._user.set(null),this._token.set(null);return}try{let e=await this.keycloak.loadUserProfile(),t=this.keycloak.tokenParsed;this._user.set({id:t?.sub||"",username:e.username||"",email:e.email||"",firstName:e.firstName||"",lastName:e.lastName||"",roles:t?.realm_access?.roles||[]}),this._token.set(this.keycloak.token||null)}catch(e){console.error("Failed to load user profile:",e)}}setupTokenRefresh(){this.keycloak&&(this.keycloak.onTokenExpired=()=>{this.keycloak?.updateToken(30).then(e=>{e&&this._token.set(this.keycloak?.token||null)}).catch(()=>{console.error("Token refresh failed"),this.logout()})},this.keycloak.onAuthSuccess=()=>{this._isAuthenticated.set(!0),this.updateUserState()},this.keycloak.onAuthLogout=()=>{this._isAuthenticated.set(!1),this._user.set(null),this._token.set(null)})}static \u0275fac=function(t){return new(t||o)};static \u0275prov=C({token:o,factory:o.\u0275fac,providedIn:"root"})};var Te=()=>{try{return localStorage.getItem("theme")||"system"}catch{return"system"}},Ie=()=>{try{let o=localStorage.getItem("simulationMode");return o===null?!0:o==="true"}catch{return!0}},Ee=()=>{try{let o=localStorage.getItem("maintenanceEnabled");return o===null?!0:o==="true"}catch{return!0}},Ce=()=>{try{let o=localStorage.getItem("infiniteConsumables");return o===null?!0:o==="true"}catch{return!0}},Ae={theme:Te(),sidebarOpen:!0,isLoading:!1,simulationMode:Ie(),maintenanceEnabled:Ee(),infiniteConsumables:Ce()},Ge=q({providedIn:"root"},B(Ae),J(()=>{let o=v(E);return{auth:I(()=>({user:o.user(),isAuthenticated:o.isAuthenticated(),token:o.token()}))}}),D(o=>{let e=v(E),t=v(F);return{toggleSidebar(){b(o,{sidebarOpen:!o.sidebarOpen()})},setTheme(r){b(o,{theme:r});try{localStorage.setItem("theme",r);let n=a=>{let c=t.getContainerElement(),l=[document.body,document.documentElement,c];if(l.forEach(u=>u.classList.remove("light-theme","dark-theme")),a==="system"){let f=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark-theme":"light-theme";l.forEach(g=>g.classList.add(f))}else{let u=`${a}-theme`;l.forEach(f=>f.classList.add(u))}};n(r);let s=window.matchMedia("(prefers-color-scheme: dark)"),i=()=>{o.theme()==="system"&&n("system")};s.removeEventListener("change",i),r==="system"&&s.addEventListener("change",i)}catch(n){console.error("Failed to save theme preference",n)}},setLoading(r){b(o,{isLoading:r})},toggleSimulationMode(){let r=!o.simulationMode();b(o,{simulationMode:r});try{localStorage.setItem("simulationMode",String(r))}catch(n){console.error("Failed to save simulation mode preference",n)}},setSimulationMode(r){b(o,{simulationMode:r});try{localStorage.setItem("simulationMode",String(r))}catch(n){console.error("Failed to save simulation mode preference",n)}},setMaintenanceEnabled(r){b(o,{maintenanceEnabled:r});try{localStorage.setItem("maintenanceEnabled",String(r))}catch(n){console.error("Failed to save maintenance enabled preference",n)}},setInfiniteConsumables(r){b(o,{infiniteConsumables:r});try{localStorage.setItem("infiniteConsumables",String(r))}catch(n){console.error("Failed to save infinite consumables preference",n)}},login(r){return e.login(r)},logout(r){return e.logout(r)},register(r){return e.register(r)}}}),D(o=>({initTheme(){o.setTheme(o.theme())}})),Y({onInit({initTheme:o}){o()}}));export{E as a,Ge as b};
