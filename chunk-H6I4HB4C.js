import{a as Z}from"./chunk-OFJDRZ5L.js";import{a as Y}from"./chunk-LAXWCL6A.js";import{a as A,c as X}from"./chunk-ZERELBVC.js";import{a as q,c as G}from"./chunk-VFPGQJKT.js";import{a as C}from"./chunk-ULQGHXUB.js";import{c as K}from"./chunk-FGBSBVHW.js";import{d as L,e as V}from"./chunk-SKMC2KSJ.js";import{A as H}from"./chunk-Q6UYEA4T.js";import{$ as D,Ga as _,I as F,T as J,Zc as b,e as W,f as z,h as M,ha as y,j as S,k as U,la as v,m as w,ma as g,q as B,r as R,v as k,w as N}from"./chunk-ZXFVGPYG.js";import{a as m,b as f}from"./chunk-RNQFGQA5.js";var Q=(s=>(s.PENDING="pending",s.RUNNING="running",s.PAUSED="paused",s.COMPLETED="completed",s.FAILED="failed",s.CANCELLED="cancelled",s))(Q||{});var E=class d{worker=null;responseMap=new Map;errorMap=new Map;stdoutSubjects=new Map;hardwareService=g(Y);interactionService=g(Z);isReady=_(!1);constructor(){this.initWorker()}initWorker(){typeof Worker<"u"?(this.worker=new Worker(new URL("worker-7C2AQKRO.js",import.meta.url),{type:"module"}),this.worker.onmessage=({data:e})=>{this.handleMessage(e)},this.sendMessage("INIT").then(()=>{this.isReady.set(!0)}).catch(e=>{console.error("[PythonRuntime] Failed to initialize Pyodide:",e)})):console.warn("Web Workers are not supported in this environment.")}connect(){return this.isReady()?R(void 0):B(this.ensureReady())}disconnect(){}execute(e){let t=crypto.randomUUID(),r=new S;return this.stdoutSubjects.set(t,r),this.ensureReady().then(()=>{if(!this.worker){r.error("Worker not active");return}this.worker.postMessage({type:"EXEC",id:t,payload:{code:e}}),this.responseMap.set(t,i=>{r.next({type:"result",content:i}),r.complete(),this.cleanupMaps(t)}),this.errorMap.set(t,i=>{r.next({type:"error",content:i}),r.complete(),this.cleanupMaps(t)})}),r.asObservable()}executeBlob(e,t,r,i){let n=t||crypto.randomUUID(),s=new S;return this.stdoutSubjects.set(n,s),this.ensureReady().then(()=>{if(!this.worker){s.error("Worker not active");return}this.worker.postMessage({type:"EXECUTE_BLOB",id:n,payload:{blob:e,machine_config:r,deck_setup_script:i}}),this.responseMap.set(n,o=>{s.next({type:"result",content:o}),s.complete(),this.cleanupMaps(n)}),this.errorMap.set(n,o=>{s.next({type:"error",content:o}),s.complete(),this.cleanupMaps(n)})}),s.asObservable()}interrupt(){this.worker&&this.worker.postMessage({type:"INTERRUPT"})}async getCompletions(e,t){if(!this.worker)return[];let r=crypto.randomUUID(),i=this.worker;return new Promise(n=>new Promise(s=>{let o=setTimeout(()=>{i?.removeEventListener("message",a),s([])},5e3),a=({data:c})=>{if(c.id===r&&c.type==="COMPLETE_RESULT"){i?.removeEventListener("message",a),clearTimeout(o);let l=c.payload.matches||[];s(l)}};i.addEventListener("message",a),i.postMessage({type:"COMPLETE",id:r,payload:{code:e}})}))}async getSignatures(e,t){if(!this.worker)return[];let r=crypto.randomUUID(),i=this.worker;return new Promise(n=>new Promise(s=>{let o=setTimeout(()=>{i?.removeEventListener("message",a),s([])},5e3),a=({data:c})=>{c.id===r&&c.type==="SIGNATURE_RESULT"&&(i?.removeEventListener("message",a),clearTimeout(o),s(c.payload.signatures||[]))};i.addEventListener("message",a),i.postMessage({type:"SIGNATURES",id:r,payload:{code:e}})}))}async install(e){return await this.ensureReady(),this.sendMessage("INSTALL",{packages:e})}ensureReady(){return this.isReady()?Promise.resolve():new Promise(e=>{let t=setInterval(()=>{this.isReady()&&(clearInterval(t),e())},100)})}sendMessage(e,t){if(!this.worker)return Promise.reject("Worker not active");let r=crypto.randomUUID();return new Promise((i,n)=>{this.responseMap.set(r,i),this.errorMap.set(r,n),this.worker.postMessage({type:e,id:r,payload:t})})}handleMessage(e){let{type:t,id:r,payload:i}=e;if(t==="STDOUT"&&r){this.stdoutSubjects.get(r)?.next({type:"stdout",content:i});return}if(t==="STDERR"&&r){this.stdoutSubjects.get(r)?.next({type:"stderr",content:i});return}if(t==="WELL_STATE_UPDATE"&&r&&i){this.stdoutSubjects.get(r)?.next({type:"well_state_update",content:JSON.stringify(i)});return}if(t==="FUNCTION_CALL_LOG"&&r&&i){this.stdoutSubjects.get(r)?.next({type:"function_call_log",content:JSON.stringify(i)});return}if(t==="RAW_IO"&&i){this.handleRawIO(i);return}if(t==="USER_INTERACTION"&&i){console.log("[PythonRuntime] USER_INTERACTION received from worker:",i),this.handleUserInteraction(i);return}if(t==="ERROR"&&r){let n=this.errorMap.get(r);n&&n(i);return}if(r){let n=this.responseMap.get(r);n&&n(i)}}async handleRawIO(e){let{command:t,port_id:r,data:i,size:n,request_id:s,baudRate:o}=e;try{switch(t){case"OPEN":await this.hardwareService.openPort(r,{baudRate:o||9600}),console.log(`[RAW_IO] Opened port ${r}`);break;case"CLOSE":await this.hardwareService.closePort(r),console.log(`[RAW_IO] Closed port ${r}`);break;case"WRITE":i&&(await this.hardwareService.writeToPort(r,new Uint8Array(i)),console.log(`[RAW_IO] Wrote ${i.length} bytes to ${r}`));break;case"READ":if(n!==void 0&&s){let a=await this.hardwareService.readFromPort(r,n);this.worker?.postMessage({type:"RAW_IO_RESPONSE",payload:{request_id:s,data:Array.from(a)}}),console.log(`[RAW_IO] Read ${a.length} bytes from ${r}`)}break;case"READLINE":if(s){let a=await this.hardwareService.readLineFromPort(r);this.worker?.postMessage({type:"RAW_IO_RESPONSE",payload:{request_id:s,data:Array.from(a)}}),console.log(`[RAW_IO] Read line from ${r}`)}break}}catch(a){console.error(`[RAW_IO] Error handling ${t} on ${r}:`,a),s&&this.worker?.postMessage({type:"RAW_IO_RESPONSE",payload:{request_id:s,data:[],error:String(a)}})}}async handleUserInteraction(e){console.log("[PythonRuntime] Calling InteractionService.handleInteraction for:",e.interaction_type);let t=await this.interactionService.handleInteraction({interaction_type:e.interaction_type,payload:e.payload});console.log("[PythonRuntime] Interaction result obtained:",t),this.worker?.postMessage({type:"USER_INTERACTION_RESPONSE",payload:{request_id:e.id,value:t}})}cleanupMaps(e){this.responseMap.delete(e),this.errorMap.delete(e),this.stdoutSubjects.delete(e)}static \u0275fac=function(t){return new(t||d)};static \u0275prov=y({token:d,factory:d.\u0275fac,providedIn:"root"})};var te={url:"",deserializer:d=>JSON.parse(d.data),serializer:d=>JSON.stringify(d)},re="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",T=class d extends U{constructor(e,t){if(super(),this._socket=null,e instanceof M)this.destination=t,this.source=e;else{let r=this._config=Object.assign({},te);if(this._output=new S,typeof e=="string")r.url=e;else for(let i in e)e.hasOwnProperty(i)&&(r[i]=e[i]);if(!r.WebSocketCtor&&WebSocket)r.WebSocketCtor=WebSocket;else if(!r.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new w}}lift(e){let t=new d(this._config,this.destination);return t.operator=e,t.source=this,t}_resetState(){this._socket=null,this.source||(this.destination=new w),this._output=new S}multiplex(e,t,r){let i=this;return new M(n=>{try{i.next(e())}catch(o){n.error(o)}let s=i.subscribe({next:o=>{try{r(o)&&n.next(o)}catch(a){n.error(a)}},error:o=>n.error(o),complete:()=>n.complete()});return()=>{try{i.next(t())}catch(o){n.error(o)}s.unsubscribe()}})}_connectSocket(){let{WebSocketCtor:e,protocol:t,url:r,binaryType:i}=this._config,n=this._output,s=null;try{s=t?new e(r,t):new e(r),this._socket=s,i&&(this._socket.binaryType=i)}catch(a){n.error(a);return}let o=new W(()=>{this._socket=null,s&&s.readyState===1&&s.close()});s.onopen=a=>{let{_socket:c}=this;if(!c){s.close(),this._resetState();return}let{openObserver:l}=this._config;l&&l.next(a);let u=this.destination;this.destination=z.create(p=>{if(s.readyState===1)try{let{serializer:h}=this._config;s.send(h(p))}catch(h){this.destination.error(h)}},p=>{let{closingObserver:h}=this._config;h&&h.next(void 0),p&&p.code?s.close(p.code,p.reason):n.error(new TypeError(re)),this._resetState()},()=>{let{closingObserver:p}=this._config;p&&p.next(void 0),s.close(),this._resetState()}),u&&u instanceof w&&o.add(u.subscribe(this.destination))},s.onerror=a=>{this._resetState(),n.error(a)},s.onclose=a=>{s===this._socket&&this._resetState();let{closeObserver:c}=this._config;c&&c.next(a),a.wasClean?n.complete():n.error(a)},s.onmessage=a=>{try{let{deserializer:c}=this._config;n.next(c(a))}catch(c){n.error(c)}}}_subscribe(e){let{source:t}=this;return t?t.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add(()=>{let{_socket:r}=this;this._output.observers.length===0&&(r&&(r.readyState===1||r.readyState===0)&&r.close(),this._resetState())}),e)}unsubscribe(){let{_socket:e}=this;e&&(e.readyState===1||e.readyState===0)&&e.close(),this._resetState(),super.unsubscribe()}};function j(d){return new T(d)}var ie={plate:["Plate","Microplate","WellPlate","Lid","PlateAdapter"],tip:["TipRack","NestedTipRack","Tips"],trough:["Trough","Reservoir"],tube:["TubeRack","Tube"],mfx:["Plate","TipRack","Trough","Reservoir"]},ne={Plate:["plate","mfx"],Microplate:["plate","mfx"],WellPlate:["plate","mfx"],Lid:["plate"],PlateAdapter:["plate"],TipRack:["tip","mfx"],NestedTipRack:["tip"],Tips:["tip"],Trough:["trough","mfx"],Reservoir:["trough","mfx"],TubeRack:["tube"],Tube:["tube"]},P=class d{constructor(e){this.deckCatalog=e}inferRequiredCarriers(e,t="HamiltonSTARDeck"){let r=[],i=this.deckCatalog.getCompatibleCarriers(t);if(!e.assets||e.assets.length===0)return[];let n=this.groupAssetsByType(e.assets),s=5;for(let[o,a]of Object.entries(n)){let c=this.findCompatibleCarriers(o,i);if(c.length===0){console.warn(`No compatible carriers for resource type: ${o}`);continue}let l=this.findOptimalCarrier(c,a.length),u=a.length,p=Math.ceil(u/l.numSlots),h=[];for(let $=0;$<p;$++)h.push(s),s+=l.railSpan+1;r.push({resourceType:o,count:p,carrierFqn:l.fqn,carrierType:l.type,carrierName:l.name,slotsNeeded:u,slotsAvailable:l.numSlots*p,suggestedRails:h,placed:!1})}return r}assignResourcesToSlots(e,t){let r=[],i=[];for(let s of t)for(let o of s.slots)o.occupied||i.push({slot:o,carrier:s});let n=0;for(let s of e){let o=this.inferResourceType(s),a=i.find(p=>this.isSlotCompatibleWithType(p.slot,p.carrier.type,o)&&!p.slot.occupied);if(!a){console.warn(`No compatible slot for asset: ${s.name}`);continue}let{slot:c,carrier:l}=a;c.occupied=!0;let u={name:s.name,type:o,location:{x:c.position.x,y:c.position.y,z:c.position.z},size_x:c.dimensions.width,size_y:c.dimensions.height,size_z:10,children:[],slot_id:c.id};c.resource=u,r.push({resource:u,slot:c,carrier:l,placementOrder:n++,placed:!1})}return r}sortByZAxis(e){return[...e].sort((t,r)=>{let i=t.resource.location?.z??t.slot.position.z,n=r.resource.location?.z??r.slot.position.z;return i-n}).map((t,r)=>f(m({},t),{placementOrder:r}))}detectStackingOrder(e){let t=[],r=new Map;for(let i of e){let n=r.get(i.slot.id)||[];n.push(i),r.set(i.slot.id,n)}for(let[i,n]of r.entries())if(n.length>1){let s=this.sortByZAxis(n);t.push({slotId:i,order:s.map(o=>o.resource.name),reason:"Stacked resources - place bottom first"})}return t}createDeckSetup(e,t="HamiltonSTARDeck"){let r=this.inferRequiredCarriers(e,t),i=[];for(let a of r){let c=this.deckCatalog.getCompatibleCarriers(t).find(l=>l.fqn===a.carrierFqn);if(c)for(let l=0;l<a.count;l++){let u=this.deckCatalog.createCarrierFromDefinition(c,`${a.carrierType}_carrier_${l}`,a.suggestedRails[l]||5+l*7);i.push(u)}}let n=this.assignResourcesToSlots(e.assets||[],i),s=this.detectStackingOrder(n),o=this.sortByZAxis(n);return{carrierRequirements:r,slotAssignments:o,stackingHints:s,complete:!1}}groupAssetsByType(e){let t={};for(let r of e){let i=this.inferResourceType(r);t[i]||(t[i]=[]),t[i].push(r)}return t}inferResourceType(e){if(e.type_hint_str){let r=e.type_hint_str;if(r.includes("Plate")||r.includes("plate"))return"Plate";if(r.includes("Tip")||r.includes("tip"))return"TipRack";if(r.includes("Trough")||r.includes("trough"))return"Trough";if(r.includes("Reservoir")||r.includes("reservoir"))return"Reservoir";if(r.includes("Tube")||r.includes("tube"))return"TubeRack"}let t=e.name.toLowerCase();return t.includes("plate")?"Plate":t.includes("tip")?"TipRack":t.includes("trough")||t.includes("reservoir")?"Trough":t.includes("tube")?"TubeRack":"Plate"}findCompatibleCarriers(e,t){let r=ne[e]||["plate"];return t.filter(i=>r.includes(i.type))}findOptimalCarrier(e,t){return[...e].sort((i,n)=>{let s=Math.ceil(t/i.numSlots)*i.numSlots-t,o=Math.ceil(t/n.numSlots)*n.numSlots-t;return s-o})[0]}isSlotCompatibleWithType(e,t,r){return(ie[t]||[]).some(n=>r===n||r.includes(n)||n.includes(r))}static \u0275fac=function(t){return new(t||d)(v(A))};static \u0275prov=y({token:d,factory:d.\u0275fac,providedIn:"root"})};var O=class d{assetService=g(X);async findCompatibleConsumable(e){try{let i=(await k(this.assetService.getResources())).filter(o=>o.status!=="reserved"&&o.status!=="in_use"&&o.status!=="expired").filter(o=>this.isTypeMatch(e.type_hint_str,o.fqn||""));if(i.length===0)return null;let n=i.map(o=>this.scoreCandidate(o,e));n.sort((o,a)=>a.totalScore-o.totalScore);let s=n[0];return s&&s.totalScore>0?(console.debug(`[ConsumableAssignment] Suggested ${s.name} for ${e.name} (Score: ${s.totalScore.toFixed(2)})`),s.resourceId):null}catch(t){return console.warn("[ConsumableAssignment] Error finding compatible consumable:",t),null}}isTypeMatch(e,t){let r=e.toLowerCase(),i=t.toLowerCase(),n={plate:["plate","well_plate","microplate"],tip:["tip","tiprack","tip_rack"],trough:["trough","reservoir","container"]};for(let[s,o]of Object.entries(n))if(r.includes(s))return o.some(a=>i.includes(a));return r.includes(i)||i.includes(r)}scoreCandidate(e,t){let r={resourceId:e.accession_id,name:e.name,totalScore:0,factors:{},warnings:[]},i=this.scoreCapacity(e,t);this.addFactor(r,"volume",i);let n=this.scoreTypeMatch(e,t);return this.addFactor(r,"type",n),this.addFactor(r,"availability",1),r}addFactor(e,t,r){e.factors[t]=r;let i=Object.keys(e.factors).length,n=Object.values(e.factors).reduce((s,o)=>s+o,0);e.totalScore=n/i}scoreCapacity(e,t){let r=e.plr_definition||{},i=0;r.nominal_volume_ul&&(i=r.nominal_volume_ul),e.properties_json&&e.properties_json.volume_ul&&(i=e.properties_json.volume_ul);let n=t.constraints.min_volume_ul||0;return i<=0?.5:n>0&&i>=n?1:n>0&&i<n?0:.5}scoreTypeMatch(e,t){let r=(t.fqn||"").toLowerCase(),i=(e.fqn||"").toLowerCase();return r&&i===r?1:r&&i.includes(r)?.8:.5}static \u0275fac=function(t){return new(t||d)};static \u0275prov=y({token:d,factory:d.\u0275fac,providedIn:"root"})};var x=class d{constructor(e,t,r){this.carrierInference=e;this.deckCatalog=t;this.consumableAssignment=r}_currentStep=_("carrier-placement");_protocol=_(null);_deckType=_("HamiltonSTARDeck");_carrierRequirements=_([]);_slotAssignments=_([]);_currentResourceIndex=_(0);_isComplete=_(!1);_skipped=_(!1);currentStep=this._currentStep.asReadonly();protocol=this._protocol.asReadonly();deckType=this._deckType.asReadonly();carrierRequirements=this._carrierRequirements.asReadonly();slotAssignments=this._slotAssignments.asReadonly();currentResourceIndex=this._currentResourceIndex.asReadonly();isComplete=this._isComplete.asReadonly();skipped=this._skipped.asReadonly();allCarriersPlaced=b(()=>this._carrierRequirements().length>0&&this._carrierRequirements().every(e=>e.placed));allResourcesPlaced=b(()=>this._slotAssignments().length>0&&this._slotAssignments().every(e=>e.placed));currentAssignment=b(()=>this._slotAssignments()[this._currentResourceIndex()]||null);pendingCarriers=b(()=>this._carrierRequirements().filter(e=>!e.placed));pendingResources=b(()=>this._slotAssignments().filter(e=>!e.placed));progress=b(()=>{let e=this._carrierRequirements(),t=this._slotAssignments(),r=e.length+t.length;if(r===0)return 0;let i=e.filter(s=>s.placed).length,n=t.filter(s=>s.placed).length;return Math.round((i+n)/r*100)});initialize(e,t="HamiltonSTARDeck",r={}){this._protocol.set(e),this._deckType.set(t),this._currentStep.set("carrier-placement"),this._currentResourceIndex.set(0),this._isComplete.set(!1),this._skipped.set(!1);let i=this.carrierInference.createDeckSetup(e,t),n=i.slotAssignments.map(s=>{let o=e.assets?.find(a=>a.name===s.resource.name);if(o&&r[o.accession_id]){let a=r[o.accession_id];return f(m({},s),{assignedAssetId:a.accession_id,placed:!1})}return f(m({},s),{placed:!1})});this._carrierRequirements.set(i.carrierRequirements),this._slotAssignments.set(n)}markCarrierPlaced(e,t=!0){this._carrierRequirements.update(r=>r.map(i=>i.carrierFqn===e?f(m({},i),{placed:t}):i))}markResourcePlaced(e,t=!0){this._slotAssignments.update(r=>r.map(i=>i.resource.name===e?f(m({},i),{placed:t}):i))}nextResource(){let e=this._currentResourceIndex(),t=this._slotAssignments().length;e<t-1&&this._currentResourceIndex.set(e+1)}previousResource(){let e=this._currentResourceIndex();e>0&&this._currentResourceIndex.set(e-1)}nextStep(){let e=this._currentStep();e==="carrier-placement"?this._currentStep.set("resource-placement"):e==="resource-placement"?this._currentStep.set("verification"):e==="verification"&&this._isComplete.set(!0)}previousStep(){let e=this._currentStep();e==="verification"?this._currentStep.set("resource-placement"):e==="resource-placement"&&this._currentStep.set("carrier-placement")}skip(){this._skipped.set(!0),this._isComplete.set(!0)}complete(){this._isComplete.set(!0)}reset(){this._currentStep.set("carrier-placement"),this._protocol.set(null),this._carrierRequirements.set([]),this._slotAssignments.set([]),this._currentResourceIndex.set(0),this._isComplete.set(!1),this._skipped.set(!1)}getState(){return{currentStep:this._currentStep(),protocol:this._protocol(),deckType:this._deckType(),carrierRequirements:this._carrierRequirements(),slotAssignments:this._slotAssignments(),currentResourceIndex:this._currentResourceIndex(),isComplete:this._isComplete(),skipped:this._skipped()}}restoreState(e){this._currentStep.set(e.currentStep),this._protocol.set(e.protocol),this._deckType.set(e.deckType),this._carrierRequirements.set(e.carrierRequirements),this._slotAssignments.set(e.slotAssignments),this._currentResourceIndex.set(e.currentResourceIndex),this._isComplete.set(e.isComplete),this._skipped.set(e.skipped)}STORAGE_KEY="praxis_deck_setup_wizard";saveToStorage(){try{let e=this.getState();localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn("Failed to save wizard state to LocalStorage:",e)}}loadFromStorage(e){try{let t=localStorage.getItem(this.STORAGE_KEY);if(!t)return!1;let r=JSON.parse(t);return e&&r.protocol?.accession_id!==e?!1:(this.restoreState(r),!0)}catch(t){return console.warn("Failed to load wizard state from LocalStorage:",t),!1}}clearStorage(){try{localStorage.removeItem(this.STORAGE_KEY)}catch(e){console.warn("Failed to clear wizard state from LocalStorage:",e)}}hasSavedState(e){try{let t=localStorage.getItem(this.STORAGE_KEY);if(!t)return!1;let r=JSON.parse(t);return!(e&&r.protocol?.accession_id!==e)}catch{return!1}}async autoAssignConsumables(){let e=this._protocol(),t=this._slotAssignments();if(!e||!e.assets)return;let r=[...t],i=!1;for(let n of e.assets){let s=r.findIndex(o=>o.resource.name===n.name);if(s!==-1){let o=r[s];if(!o.assignedAssetId){let a=await this.consumableAssignment.findCompatibleConsumable(n);a&&(r[s]=f(m({},o),{assignedAssetId:a}),i=!0)}}}i&&this._slotAssignments.set(r)}getAssetMap(){let e={},t=this._slotAssignments(),r=this._protocol();return r&&r.assets&&r.assets.forEach(i=>{let n=t.find(s=>s.resource.name===i.name);n&&n.placed&&(e[i.accession_id]={name:i.name,accession_id:n.assignedAssetId||void 0,physically_placed:!0})}),e}serializeToPython(){let e=this._slotAssignments(),t=this._deckType(),r=`import pylabrobot.resources as res
`;t.includes("HamiltonSTAR")?(r+=`from pylabrobot.resources.hamilton import HamiltonSTARDeck
`,r+=`from pylabrobot.resources.hamilton import *
`):t.includes("OTDeck")&&(r+=`from pylabrobot.resources.opentrons import OTDeck
`),r+=`
def setup_deck():
`,t.includes("HamiltonSTAR")?r+=`    deck = HamiltonSTARDeck()
`:t.includes("OTDeck")?r+=`    deck = OTDeck()
`:r+=`    deck = res.Deck()
`;let i=new Map,n=new Map;return e.forEach(s=>{s.placed&&s.carrier&&n.set(s.carrier.id,s.carrier)}),n.forEach((s,o)=>{let a=o.replace(/[^a-zA-Z0-9_]/g,"_");i.set(o,a);let c=s.fqn.split(".").pop()?.toUpperCase()||"Carrier";r+=`    ${a} = ${c}(name="${s.name}")
`,s.railPosition!==void 0&&(r+=`    deck.assign_child_resource(${a}, rails=${s.railPosition})
`)}),e.forEach((s,o)=>{if(s.placed){let a=`labware_${o}`,c=i.get(s.carrier.id);if(c){let l="Resource";s.resource.type==="Plate"||s.resource.type==="Trough"||s.resource.type==="Reservoir"?l="Plate":s.resource.type==="TipRack"&&(l="TipRack"),r+=`    ${a} = res.${l}(name="${s.resource.name}", size_x=${s.resource.size_x}, size_y=${s.resource.size_y}, size_z=${s.resource.size_z})
`,r+=`    ${c}[${s.slot.index}] = ${a}
`}else if(t.includes("OTDeck")){let l="Resource";s.resource.type==="Plate"?l="Plate":s.resource.type==="TipRack"&&(l="TipRack"),r+=`    ${a} = res.${l}(name="${s.resource.name}", size_x=${s.resource.size_x}, size_y=${s.resource.size_y}, size_z=${s.resource.size_z})
`,r+=`    deck.assign_child_at_slot(${a}, ${s.slot.index+1})
`}}}),r+=`    return deck

deck = setup_deck()
`,r}static \u0275fac=function(t){return new(t||d)(v(P),v(A),v(O))};static \u0275prov=y({token:d,factory:d.\u0275fac,providedIn:"root"})};var ee=class d{modeService=g(G);pythonRuntime=g(E);sqliteService=g(V);http=g(H);wizardState=g(x);WS_URL=q.wsUrl;API_URL=q.apiUrl;socket$=null;messagesSubject=new S;_currentRun=_(null);_isConnected=_(!1);lastSavedState=null;currentRun=this._currentRun.asReadonly();isConnected=this._isConnected.asReadonly();isRunning=b(()=>this._currentRun()?.status==="running");isPaused=b(()=>this._currentRun()?.status==="paused");messages$=this.messagesSubject.asObservable();apiWrapper=g(K);fetchProtocolBlob(e){return this.modeService.isBrowserMode()?this.http.get(`/assets/protocols/${e}.pkl`,{responseType:"arraybuffer"}):this.http.get(`${this.API_URL}/api/v1/protocols/definitions/${e}/code/binary`,{responseType:"arraybuffer"})}getCompatibility(e){return this.modeService.isBrowserMode()?this.sqliteService.machineDefinitions.pipe(N(t=>t.findAll()),N(t=>t.map(r=>({machine:{accession_id:`template-${r.accession_id}`,name:r.name,machine_category:r.machine_category,is_simulation_override:!0,simulation_backend_name:r.available_simulation_backends?.[0]||"Chatterbox",description:r.description,machine_definition_accession_id:r.accession_id,is_template:!0},compatibility:{is_compatible:!0,missing_capabilities:[],matched_capabilities:[],warnings:[]}})))):this.apiWrapper.wrap(C.getProtocolCompatibilityApiV1ProtocolsAccessionIdCompatibilityGet(e))}startRun(e,t,r,i=!0,n){return this.modeService.isBrowserMode()?this.startBrowserRun(e,t,r,n):this.apiWrapper.wrap(C.startProtocolRunApiV1ProtocolsRunsActionsStartPost({protocol_definition_accession_id:e,name:t,parameters:r,simulation_mode:i})).pipe(D(s=>{this._currentRun.set({runId:s.run_id,protocolName:t,status:"pending",progress:0,logs:[]}),this.connectWebSocket(s.run_id)}))}startBrowserRun(e,t,r,i){let n=crypto.randomUUID();this._currentRun.set({runId:n,protocolName:t,status:"pending",progress:0,logs:["[Browser Mode] Starting execution..."]});let s={accession_id:n,protocol_definition_accession_id:e,name:t,status:"queued",created_at:new Date().toISOString(),updated_at:new Date().toISOString(),start_time:null,end_time:null,data_directory_path:null,input_parameters_json:r||{},properties_json:{notes:i,simulation_mode:!0},top_level_protocol_definition_accession_id:e,duration_ms:null,resolved_assets_json:null,output_data_json:null,initial_state_json:null,final_state_json:null,created_by_user:null,previous_accession_id:null};return this.sqliteService.createProtocolRun(s).subscribe({error:o=>console.warn("[ExecutionService] Failed to persist run:",o)}),this.executeBrowserProtocol(e,n,r),R({run_id:n})}async executeBrowserProtocol(e,t,r){try{this.updateRunState({status:"running"}),this.addLog("[Browser Mode] Loading protocol...");let i=await k(this.sqliteService.getProtocolRun(t)),n=null;if(i?.resolved_assets_json)try{let a=typeof i.resolved_assets_json=="string"?JSON.parse(i.resolved_assets_json):i.resolved_assets_json,l=(Array.isArray(a)?a:Object.values(a)).find(u=>u.machine_instance||u.definition);if(l){let u=l.machine_instance,p=l.definition;n={backend_fqn:p.fqn,port_id:u?.backend_config?.port_id,baudrate:u?.backend_config?.baudrate,is_simulated:p.is_simulation_override||!1},this.addLog(`[Browser Mode] Using machine: ${p.name} (${p.fqn})`)}}catch(a){console.warn("[ExecutionService] Failed to parse resolved_assets_json:",a)}let s=await k(this.fetchProtocolBlob(e)),o=this.wizardState.serializeToPython();this.addLog("[Browser Mode] Executing protocol binary"),this.updateRunState({progress:20,currentStep:"Running protocol"}),await new Promise((a,c)=>{let l=!1;this.pythonRuntime.executeBlob(s,t,n,o).subscribe({next:u=>{if(u.type==="stdout")this.addLog(u.content);else if(u.type==="stderr")this.addLog(`[Error] ${u.content}`),l=!0;else if(u.type==="result")this.addLog(`[Result] ${u.content}`);else if(u.type==="well_state_update")try{let p=JSON.parse(u.content),h=this._currentRun();h&&this._currentRun.set(f(m({},h),{wellState:p}))}catch(p){console.error("[ExecutionService] Error parsing browser state update:",p)}else if(u.type==="function_call_log")try{let p=JSON.parse(u.content);this.handleFunctionCallLog(t,p)}catch(p){console.error("[ExecutionService] Error parsing function call log:",p)}},error:u=>{this.addLog(`[Error] Execution failed: ${u}`),c(u)},complete:()=>{l?c(new Error("Protocol execution had errors")):a()}})}),this.updateRunState({status:"completed",progress:100,endTime:new Date().toISOString()}),this.addLog("[Browser Mode] Execution completed successfully."),this.sqliteService.updateProtocolRunStatus(t,"COMPLETED").subscribe()}catch(i){console.error("[Browser Execution Error]",i);let n=this._currentRun();n&&this._currentRun.set(f(m({},n),{status:"failed",logs:[...n.logs,`[Error] ${String(i)}`]})),this.sqliteService.updateProtocolRunStatus(t,"FAILED").subscribe()}}buildProtocolExecutionCode(e,t,r,i){let n=e.module_name||e.fqn.split(".").slice(0,-1).join("."),s=e.function_name||e.fqn.split(".").pop()||"run",o=t?JSON.stringify(t):"{}",a=r?JSON.stringify(r):"{}",c={};e.parameters&&e.parameters.forEach(h=>{c[h.name]=h.type_hint});let l={};e.assets&&e.assets.forEach(h=>{l[h.accession_id]=h.type_hint_str});let u=JSON.stringify(c),p=JSON.stringify(l);return`
# Browser mode protocol execution
import json
import time
from web_bridge import resolve_parameters, patch_state_emission, patch_function_call_logging

print("[Browser] Setting up simulation environment...")

# Import the protocol module
try:
    from ${n} import ${s}
except ImportError as e:
    print(f"[Browser] Protocol import not available in browser: {e}")
    print("[Browser] Running simulation placeholder instead...")

    # Simulation placeholder
    def ${s}(*args, **kwargs):
        print("[Simulation] Protocol started")
        return {"status": "simulated"}

# Parse parameters and metadata
params = json.loads('''${o}''')
metadata = json.loads('''${u}''')
asset_reqs = json.loads('''${p}''')
asset_specs = json.loads('''${a}''')

# Resolve parameters (instantiate PLR objects for plates/etc)
print("[Browser] Resolving parameters...")
resolved_params = resolve_parameters(params, metadata, asset_reqs, asset_specs)

# Patch for real-time state emission (searching for LiquidHandler in resolved_params)
for p_value in resolved_params.values():
    try:
        from pylabrobot.liquid_handling import LiquidHandler
        if isinstance(p_value, LiquidHandler):
            patch_state_emission(p_value)
            patch_function_call_logging(p_value, '${i}')
    except ImportError:
        pass

# Execute the protocol
print("[Browser] Executing protocol...")
result = ${s}(**resolved_params) if resolved_params else ${s}()
print(f"[Browser] Protocol finished with result: {result}")
`}updateRunState(e){let t=this._currentRun();t&&this._currentRun.set(m(m({},t),e))}addLog(e){let t=this._currentRun();t&&(this._currentRun.set(f(m({},t),{logs:[...t.logs,e]})),this.messagesSubject.next({type:"log",payload:{message:e},timestamp:new Date().toISOString()}))}connectWebSocket(e){this.socket$&&this.socket$.complete(),this.socket$=j({url:`${this.WS_URL}/execution/${e}`,openObserver:{next:()=>{console.log("WebSocket connected for run:",e),this._isConnected.set(!0)}},closeObserver:{next:()=>{console.log("WebSocket disconnected"),this._isConnected.set(!1)}}}),this.socket$.pipe(J({delay:3e3,count:3}),F(t=>(console.error("WebSocket error:",t),this._isConnected.set(!1),R()))).subscribe({next:t=>this.handleMessage(t),error:t=>console.error("WebSocket subscription error:",t)})}handleMessage(e){this.messagesSubject.next(e);let t=this._currentRun();if(t)switch(e.type){case"status":this._currentRun.set(f(m({},t),{status:e.payload.status,currentStep:e.payload.step,plr_definition:e.payload.plr_definition}));break;case"log":this._currentRun.set(f(m({},t),{logs:[...t.logs,e.payload.message]}));break;case"progress":this._currentRun.set(f(m({},t),{progress:e.payload.progress}));break;case"complete":this._currentRun.set(f(m({},t),{status:"completed",progress:100,endTime:e.timestamp})),this.disconnect();break;case"error":this._currentRun.set(f(m({},t),{status:"failed",logs:[...t.logs,`ERROR: ${e.payload.error}`]})),this.disconnect();break;case"telemetry":this._currentRun.set(f(m({},t),{telemetry:{temperature:e.payload.temperature,absorbance:e.payload.absorbance}}));break;case"well_state_update":this._currentRun.set(f(m({},t),{wellState:e.payload}));break}}pauseRun(){let e=this._currentRun()?.runId;return e?this.http.post(`${this.API_URL}/api/v1/execution/runs/${e}/pause`,{}):R(void 0)}resumeRun(){let e=this._currentRun()?.runId;return e?this.http.post(`${this.API_URL}/api/v1/execution/runs/${e}/resume`,{}):R(void 0)}stopRun(){let e=this._currentRun()?.runId;if(!e)return R(void 0);if(e.startsWith("browser-")){this.pythonRuntime.interrupt();let t=this._currentRun();return t&&this._currentRun.set(f(m({},t),{status:"cancelled"})),R(void 0)}return this.apiWrapper.wrap(C.cancelProtocolRunApiV1ProtocolsRunsRunIdCancelPost(e)).pipe(D(()=>{let t=this._currentRun();t&&this._currentRun.set(f(m({},t),{status:"cancelled"})),this.disconnect()}))}disconnect(){this.socket$&&(this.socket$.complete(),this.socket$=null),this._isConnected.set(!1)}clearRun(){this._currentRun.set(null),this.lastSavedState=null,this.disconnect()}handleFunctionCallLog(e,t){if(t.status!=="running"){!this.lastSavedState&&t.state_before&&(this.sqliteService.updateProtocolRun(e,{initial_state_json:JSON.stringify(t.state_before)}).subscribe(),this.lastSavedState=t.state_before);let r=null;if(t.state_before){let s=L(this.lastSavedState,t.state_before);s&&(r=JSON.stringify({_is_diff:!0,diff:s})),this.lastSavedState=t.state_before}let i=null;if(t.state_after){let s=L(this.lastSavedState,t.state_after);s&&(i=JSON.stringify({_is_diff:!0,diff:s})),this.lastSavedState=t.state_after}let n={accession_id:t.call_id,protocol_run_accession_id:e,function_protocol_definition_accession_id:"browser_execution",sequence_in_run:t.sequence,name:t.method_name,status:t.status==="completed"?"COMPLETED":"FAILED",start_time:new Date(t.start_time*1e3).toISOString(),end_time:t.end_time?new Date(t.end_time*1e3).toISOString():null,duration_ms:t.duration_ms??null,input_args_json:JSON.stringify(t.args),state_before_json:r,state_after_json:i,error_message_text:t.error_message??null};this.sqliteService.createFunctionCallLog(n).subscribe({error:s=>console.warn("[ExecutionService] Failed to persist function call log:",s)})}}static \u0275fac=function(t){return new(t||d)};static \u0275prov=y({token:d,factory:d.\u0275fac,providedIn:"root"})};export{Q as a,P as b,x as c,ee as d};
