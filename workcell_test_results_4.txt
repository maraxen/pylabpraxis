============================= test session starts ==============================
platform darwin -- Python 3.13.5, pytest-8.4.2, pluggy-1.6.0 -- /Users/mar/Projects/pylabpraxis/.venv/bin/python3
cachedir: .pytest_cache
Database: SQLite (in-memory)
rootdir: /Users/mar/Projects/pylabpraxis
configfile: pyproject.toml
plugins: playwright-0.7.2, asyncio-1.2.0, anyio-4.11.0, socket-0.7.0, xdist-3.8.0, timeout-2.4.0, Faker-37.11.0, base-url-2.1.0, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
timeout: 300.0s
timeout method: signal
timeout func_only: False
collecting ... collected 15 items

tests/models/test_domain/test_workcell.py::test_workcell_orm_creation_with_defaults PASSED [  6%]
tests/models/test_domain/test_workcell.py::test_workcell_orm_persist_to_database FAILED [ 13%]
tests/models/test_domain/test_workcell.py::test_workcell_orm_unique_name_constraint PASSED [ 20%]
tests/models/test_domain/test_workcell.py::test_workcell_orm_relationships_empty_by_default PASSED [ 26%]
tests/models/test_domain/test_workcell.py::test_workcell_orm_with_custom_status PASSED [ 33%]
tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_base_minimal PASSED [ 40%]
tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_base_with_all_fields FAILED [ 46%]
tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_create_inherits_from_base PASSED [ 53%]
tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_update_all_fields_optional PASSED [ 60%]
tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_response_serialization_to_dict FAILED [ 66%]
tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_response_serialization_to_json PASSED [ 73%]
tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_response_deserialization_from_dict PASSED [ 80%]
tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_response_enum_validation PASSED [ 86%]
tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_response_roundtrip_serialization PASSED [ 93%]
tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_response_from_model PASSED [100%]
ERROR: Coverage failure: total of 12 is less than fail-under=80


=================================== FAILURES ===================================
____________________ test_workcell_orm_persist_to_database _____________________
.venv/lib/python3.13/site-packages/sqlalchemy/sql/sqltypes.py:1709: in _object_value_for_elem
    return self._object_lookup[elem]  # type: ignore[return-value]
           ^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'available'

The above exception was the direct cause of the following exception:
tests/models/test_domain/test_workcell.py:57: in test_workcell_orm_persist_to_database
    result = await db_session.execute(
.venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py:449: in execute
    result = await greenlet_spawn(
.venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2351: in execute
    return self._execute_internal(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py:2249: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:309: in orm_execute_statement
    return cls.orm_setup_cursor_result(
.venv/lib/python3.13/site-packages/sqlalchemy/orm/context.py:616: in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/loading.py:262: in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/orm/loading.py:220: in chunks
    fetch = cursor._raw_all_rows()
            ^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/engine/result.py:541: in _raw_all_rows
    return [make_row(row) for row in rows]
            ^^^^^^^^^^^^^
lib/sqlalchemy/cyextension/resultproxy.pyx:22: in sqlalchemy.cyextension.resultproxy.BaseRow.__init__
    ???
lib/sqlalchemy/cyextension/resultproxy.pyx:79: in sqlalchemy.cyextension.resultproxy._apply_processors
    ???
.venv/lib/python3.13/site-packages/sqlalchemy/sql/sqltypes.py:1829: in process
    value = self._object_value_for_elem(value)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/sqlalchemy/sql/sqltypes.py:1711: in _object_value_for_elem
    raise LookupError(
E   LookupError: 'available' is not among the defined enum values. Enum name: workcellstatusenum. Possible values: ACTIVE, IN_USE, RESERVED, ..., MAINTENANCE
____________ TestWorkcellSchemas.test_workcell_base_with_all_fields ____________
tests/models/test_domain/test_workcell.py:167: in test_workcell_base_with_all_fields
    assert workcell.latest_state_json == state
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/pydantic/main.py:1026: in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E   AttributeError: 'WorkcellBase' object has no attribute 'latest_state_json'
_______ TestWorkcellSchemas.test_workcell_response_serialization_to_dict _______
tests/models/test_domain/test_workcell.py:206: in test_workcell_response_serialization_to_dict
    assert data["machines"] == []
           ^^^^^^^^^^^^^^^^
E   KeyError: 'machines'
================================ tests coverage ================================
_______________ coverage: platform darwin, python 3.13.5-final-0 _______________

Name                                                                                  Stmts   Miss  Cover   Missing
-------------------------------------------------------------------------------------------------------------------
praxis/backend/__init__.py                                                                1      0   100%
praxis/backend/api/__init__.py                                                            4      4     0%   8-14
praxis/backend/api/auth.py                                                               49     49     0%   3-181
praxis/backend/api/decks.py                                                               9      9     0%   3-31
praxis/backend/api/dependencies.py                                                       30     30     0%   3-67
praxis/backend/api/discovery.py                                                          16     16     0%   3-39
praxis/backend/api/global_dependencies.py                                                33     33     0%   10-74
praxis/backend/api/hardware.py                                                          149    149     0%   7-500
praxis/backend/api/machines.py                                                           47     47     0%   7-170
praxis/backend/api/outputs.py                                                             9      9     0%   3-31
praxis/backend/api/protocols.py                                                         134    134     0%   7-467
praxis/backend/api/repl.py                                                               64     64     0%   1-134
praxis/backend/api/resources.py                                                          38     38     0%   8-124
praxis/backend/api/scheduler.py                                                         105    105     0%   1-395
praxis/backend/api/utils/__init__.py                                                      0      0   100%
praxis/backend/api/utils/crud_router_factory.py                                          40     40     0%   3-90
praxis/backend/api/websockets.py                                                         65     65     0%   1-151
praxis/backend/api/workcell.py                                                            7      7     0%   7-20
praxis/backend/celery_app.py                                                              2      2     0%   1-3
praxis/backend/configure.py                                                             152     64    58%   43, 49, 61-69, 81-87, 117, 122, 127, 132, 137-139, 144, 149, 157, 176, 188-190, 195, 200, 205, 210, 215-217, 222, 227, 232, 241-248, 253-254, 259, 264-265, 274-287, 293-295, 305-306, 322-329
praxis/backend/core/__init__.py                                                           2      2     0%   3-5
praxis/backend/core/asset_lock_manager.py                                                39     39     0%   3-76
praxis/backend/core/asset_manager/__init__.py                                             8      8     0%   3-28
praxis/backend/core/asset_manager/core.py                                                52     52     0%   4-149
praxis/backend/core/asset_manager/deck_manager.py                                        74     74     0%   5-217
praxis/backend/core/asset_manager/location_handler.py                                    46     46     0%   4-95
praxis/backend/core/asset_manager/machine_manager.py                                     79     79     0%   4-205
praxis/backend/core/asset_manager/resource_manager.py                                   129    129     0%   4-380
praxis/backend/core/celery.py                                                             4      4     0%   7-15
praxis/backend/core/celery_base.py                                                       12     12     0%   1-23
praxis/backend/core/celery_tasks.py                                                      72     72     0%   9-203
praxis/backend/core/consumable_assignment.py                                            165    165     0%   17-456
praxis/backend/core/container.py                                                         49     49     0%   10-215
praxis/backend/core/deck_config.py                                                       82     82     0%   16-263
praxis/backend/core/decorators/__init__.py                                                5      5     0%   1-23
praxis/backend/core/decorators/definition_builder.py                                     50     50     0%   1-188
praxis/backend/core/decorators/models.py                                                 60     60     0%   1-153
praxis/backend/core/decorators/parameter_processor.py                                    50     50     0%   1-130
praxis/backend/core/decorators/protocol_decorator.py                                    206    206     0%   1-547
praxis/backend/core/filesystem.py                                                        21     21     0%   3-61
praxis/backend/core/orchestrator/__init__.py                                              3      3     0%   3-12
praxis/backend/core/orchestrator/asset_acquisition.py                                    58     58     0%   3-151
praxis/backend/core/orchestrator/core.py                                                 26     26     0%   5-81
praxis/backend/core/orchestrator/error_handling.py                                       75     75     0%   3-191
praxis/backend/core/orchestrator/execution.py                                           175    175     0%   3-465
praxis/backend/core/orchestrator/protocol_preparation.py                                 75     75     0%   3-205
praxis/backend/core/precondition_resolver.py                                            181    181     0%   14-523
praxis/backend/core/protocol_cache.py                                                   128    128     0%   14-473
praxis/backend/core/protocol_code_manager.py                                            152    152     0%   14-520
praxis/backend/core/protocol_execution_service.py                                        99     99     0%   9-304
praxis/backend/core/protocols/__init__.py                                                 0      0   100%
praxis/backend/core/protocols/asset_lock_manager.py                                       5      5     0%   1-8
praxis/backend/core/protocols/asset_manager.py                                            7      7     0%   3-11
praxis/backend/core/protocols/filesystem.py                                               1      1     0%   1
praxis/backend/core/protocols/orchestrator.py                                             2      2     0%   3-5
praxis/backend/core/protocols/protocol_code_manager.py                                    3      3     0%   3-6
praxis/backend/core/protocols/protocol_execution_service.py                               3      3     0%   3-6
praxis/backend/core/protocols/scheduler.py                                                2      2     0%   3-4
praxis/backend/core/protocols/workcell.py                                                 3      3     0%   3-6
praxis/backend/core/protocols/workcell_runtime.py                                         7      7     0%   3-11
praxis/backend/core/repl_session.py                                                      72     72     0%   3-128
praxis/backend/core/run_context.py                                                       50     50     0%   19-130
praxis/backend/core/scheduler.py                                                        282    282     0%   4-731
praxis/backend/core/simulation/__init__.py                                               10     10     0%   22-92
praxis/backend/core/simulation/bounds_analyzer.py                                       113    113     0%   7-356
praxis/backend/core/simulation/failure_detector.py                                      126    126     0%   7-386
praxis/backend/core/simulation/graph_replay.py                                          152    152     0%   18-488
praxis/backend/core/simulation/method_contracts.py                                       80     80     0%   11-546
praxis/backend/core/simulation/pipeline.py                                              148    148     0%   13-545
praxis/backend/core/simulation/simulator.py                                              59     59     0%   8-294
praxis/backend/core/simulation/state_models.py                                          268    268     0%   12-582
praxis/backend/core/simulation/state_resolution.py                                      163    163     0%   20-608
praxis/backend/core/simulation/stateful_tracers.py                                      188    188     0%   8-499
praxis/backend/core/storage/__init__.py                                                   3      3     0%   16-27
praxis/backend/core/storage/celery_adapter.py                                            40     40     0%   7-132
praxis/backend/core/storage/factory.py                                                   75     75     0%   24-242
praxis/backend/core/storage/memory_adapter.py                                           233    233     0%   18-395
praxis/backend/core/storage/protocols.py                                                  2      2     0%   13-14
praxis/backend/core/storage/redis_adapter.py                                            162    162     0%   9-327
praxis/backend/core/storage/sqlite_adapter.py                                           106    106     0%   19-279
praxis/backend/core/tracing/__init__.py                                                   4      4     0%   8-18
praxis/backend/core/tracing/executor.py                                                  73     73     0%   8-323
praxis/backend/core/tracing/recorder.py                                                 121    121     0%   7-360
praxis/backend/core/tracing/tracers.py                                                  144    144     0%   11-447
praxis/backend/core/workcell.py                                                         107    107     0%   13-242
praxis/backend/core/workcell_runtime/__init__.py                                          2      2     0%   1-3
praxis/backend/core/workcell_runtime/core.py                                             38     38     0%   3-72
praxis/backend/core/workcell_runtime/deck_manager.py                                    201    201     0%   4-487
praxis/backend/core/workcell_runtime/machine_manager.py                                 171    171     0%   4-426
praxis/backend/core/workcell_runtime/resource_manager.py                                 83     83     0%   4-208
praxis/backend/core/workcell_runtime/state_sync.py                                       91     91     0%   3-180
praxis/backend/core/workcell_runtime/utils.py                                            13     13     0%   3-26
praxis/backend/main.py                                                                  156    156     0%   3-353
praxis/backend/models/__init__.py                                                        14      0   100%
praxis/backend/models/domain/__init__.py                                                 14      0   100%
praxis/backend/models/domain/asset.py                                                    37      0   100%
praxis/backend/models/domain/deck.py                                                    151     27    82%   15, 20-22, 198, 236-240, 245-249, 254-258, 298-300, 305-307, 331
praxis/backend/models/domain/filters.py                                                  17      0   100%
praxis/backend/models/domain/machine.py                                                 124      4    97%   20-23
praxis/backend/models/domain/outputs.py                                                 152      5    97%   17-21
praxis/backend/models/domain/plr_sync.py                                                  8      0   100%
praxis/backend/models/domain/protocol.py                                                229      1    99%   23
praxis/backend/models/domain/protocol_source.py                                          45      1    98%   16
praxis/backend/models/domain/resolution.py                                               36      2    94%   15-16
praxis/backend/models/domain/resource.py                                                164     16    90%   17-20, 157-159, 164-166, 240-242, 247-249
praxis/backend/models/domain/schedule.py                                                169      1    99%   21
praxis/backend/models/domain/sqlmodel_base.py                                            21      3    86%   38-44
praxis/backend/models/domain/user.py                                                     26      0   100%
praxis/backend/models/domain/workcell.py                                                 36      3    92%   14-16
praxis/backend/models/enums/__init__.py                                                  10      0   100%
praxis/backend/models/enums/asset.py                                                     14      0   100%
praxis/backend/models/enums/machine.py                                                   30      1    97%   53
praxis/backend/models/enums/outputs.py                                                   29      0   100%
praxis/backend/models/enums/plr_category.py                                              81     47    42%   109-119, 136-178
praxis/backend/models/enums/protocol.py                                                  30      0   100%
praxis/backend/models/enums/resolution.py                                                11      0   100%
praxis/backend/models/enums/resource.py                                                  60      3    95%   101, 121, 135
praxis/backend/models/enums/schedule.py                                                  33      0   100%
praxis/backend/models/enums/workcell.py                                                  12      1    92%   28
praxis/backend/models/pydantic_internals/__init__.py                                     13      0   100%
praxis/backend/models/pydantic_internals/maintenance.py                                  22     22     0%   1-43
praxis/backend/models/pydantic_internals/plr_sync.py                                     17     17     0%   3-39
praxis/backend/models/pydantic_internals/pydantic_base.py                                13      1    92%   45
praxis/backend/models/pydantic_internals/runtime.py                                      42      3    93%   31, 42-43
praxis/backend/services/__init__.py                                                      13     13     0%   14-31
praxis/backend/services/async_state.py                                                   89     89     0%   8-208
praxis/backend/services/capability_matcher.py                                            63     63     0%   7-217
praxis/backend/services/deck.py                                                         135    135     0%   8-325
praxis/backend/services/deck_type_definition.py                                          26     26     0%   3-59
praxis/backend/services/discovery_service.py                                            112    112     0%   12-276
praxis/backend/services/entity_linking.py                                               147    147     0%   8-405
praxis/backend/services/hardware_connection_manager.py                                  118    118     0%   25-380
praxis/backend/services/hardware_discovery.py                                           129    129     0%   12-457
praxis/backend/services/machine.py                                                      110    110     0%   10-255
praxis/backend/services/machine_type_definition.py                                       65     65     0%   3-173
praxis/backend/services/mock_data_generator.py                                           89     89     0%   3-166
praxis/backend/services/outputs.py                                                       66     66     0%   8-159
praxis/backend/services/plate_parsing.py                                                 60     60     0%   8-144
praxis/backend/services/plate_viz.py                                                     25     25     0%   10-99
praxis/backend/services/plr_type_base.py                                                  8      8     0%   3-19
praxis/backend/services/praxis_orm_service.py                                           171    171     0%   12-433
praxis/backend/services/protocol_definition.py                                          135    135     0%   3-392
praxis/backend/services/protocol_output_data.py                                          24     24     0%   8-125
praxis/backend/services/protocols.py                                                    172    172     0%   12-421
praxis/backend/services/resource.py                                                     111    111     0%   4-274
praxis/backend/services/resource_type_definition.py                                     280    280     0%   3-699
praxis/backend/services/scheduler.py                                                    176    176     0%   12-574
praxis/backend/services/simulation_service.py                                           135    135     0%   12-516
praxis/backend/services/state.py                                                        124    124     0%   3-274
praxis/backend/services/state_resolution_service.py                                     150    150     0%   16-487
praxis/backend/services/type_definition_base.py                                           6      6     0%   3-14
praxis/backend/services/user.py                                                         116    116     0%   8-337
praxis/backend/services/utils/__init__.py                                                 2      2     0%   3-10
praxis/backend/services/utils/crud_base.py                                              104    104     0%   3-203
praxis/backend/services/utils/plr_type_base.py                                           56     56     0%   3-116
praxis/backend/services/utils/query_builder.py                                           66     66     0%   8-209
praxis/backend/services/well_outputs.py                                                 123    123     0%   8-329
praxis/backend/services/workcell.py                                                      83     83     0%   12-202
praxis/backend/utils/__init__.py                                                          7      0   100%
praxis/backend/utils/accession_resolver.py                                               19     19     0%   6-68
praxis/backend/utils/auth.py                                                             62     62     0%   7-124
praxis/backend/utils/db.py                                                              120     62    48%   35-37, 43, 58-61, 68-92, 100-132, 141-142, 204-211, 219-239, 247-248, 256, 276, 297
praxis/backend/utils/db_decorator.py                                                     34     34     0%   3-76
praxis/backend/utils/errors.py                                                           62     30    52%   19-20, 24, 42-43, 47, 65-66, 70, 88-89, 93, 111-112, 116, 134-135, 139, 158-159, 163, 181-182, 186, 201-202, 223-224, 236, 254
praxis/backend/utils/filesystem.py                                                        4      4     0%   1-9
praxis/backend/utils/logging.py                                                          47     38    19%   12-18, 32-48, 92-111, 155-174
praxis/backend/utils/notify.py                                                           27     13    52%   63-74, 95-96
praxis/backend/utils/plr_inspection.py                                                  207    207     0%   11-716
praxis/backend/utils/plr_static_analysis/__init__.py                                      3      3     0%   15-33
praxis/backend/utils/plr_static_analysis/cache.py                                        68     68     0%   3-172
praxis/backend/utils/plr_static_analysis/capability_config_templates.py                  21     21     0%   8-412
praxis/backend/utils/plr_static_analysis/connection_config_templates.py                  17     17     0%   8-148
praxis/backend/utils/plr_static_analysis/manufacturer_inference.py                       16     16     0%   5-123
praxis/backend/utils/plr_static_analysis/models.py                                      280    280     0%   3-655
praxis/backend/utils/plr_static_analysis/parser.py                                      218    218     0%   3-532
praxis/backend/utils/plr_static_analysis/resource_hierarchy.py                          116    116     0%   12-492
praxis/backend/utils/plr_static_analysis/type_annotation_analyzer.py                    109    109     0%   7-304
praxis/backend/utils/plr_static_analysis/visitors/__init__.py                             6      6     0%   3-16
praxis/backend/utils/plr_static_analysis/visitors/base.py                                56     56     0%   3-135
praxis/backend/utils/plr_static_analysis/visitors/capability_extractor.py               228    228     0%   3-536
praxis/backend/utils/plr_static_analysis/visitors/class_discovery.py                    177    177     0%   3-593
praxis/backend/utils/plr_static_analysis/visitors/computation_graph_extractor.py        244    244     0%   14-673
praxis/backend/utils/plr_static_analysis/visitors/protocol_discovery.py                  91     91     0%   3-262
praxis/backend/utils/plr_static_analysis/visitors/protocol_requirement_extractor.py      86     86     0%   7-298
praxis/backend/utils/plr_static_analysis/visitors/resource_factory.py                   109    109     0%   13-328
praxis/backend/utils/redis_lock.py                                                       21     15    29%   30-49
praxis/backend/utils/run_control.py                                                      38     38     0%   3-90
praxis/backend/utils/sanitation.py                                                      151    132    13%   24-25, 43-54, 68-86, 91-109, 117, 136-142, 152-157, 183-218, 231-234, 248, 252-261, 269-283, 320-349, 366-372
praxis/backend/utils/type_inspection.py                                                  24     24     0%   4-64
praxis/backend/utils/uuid.py                                                              9      3    67%   34, 39-40
praxis/common/__init__.py                                                                 0      0   100%
praxis/common/type_inspection.py                                                        124    124     0%   4-313
praxis/protocol/__init__.py                                                               2      2     0%   6-12
praxis/protocol/protocols/__init__.py                                                     7      7     0%   13-20
praxis/protocol/protocols/kinetic_assay.py                                               55     55     0%   10-204
praxis/protocol/protocols/plate_preparation.py                                           50     50     0%   7-143
praxis/protocol/protocols/plate_reader_assay.py                                          28     28     0%   10-134
praxis/protocol/protocols/selective_transfer.py                                          52     52     0%   8-218
praxis/protocol/protocols/serial_dilution.py                                             30     30     0%   7-134
praxis/protocol/protocols/simple_transfer.py                                             20     20     0%   7-112
-------------------------------------------------------------------------------------------------------------------
TOTAL                                                                                 14694  12952    12%
Coverage HTML written to dir htmlcov
FAIL Required test coverage of 80% not reached. Total coverage: 11.86%
=========================== short test summary info ============================
FAILED tests/models/test_domain/test_workcell.py::test_workcell_orm_persist_to_database
FAILED tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_base_with_all_fields
FAILED tests/models/test_domain/test_workcell.py::TestWorkcellSchemas::test_workcell_response_serialization_to_dict
================== 3 failed, 12 passed, 10 warnings in 2.27s ===================
